<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš‡å®¶èµŒåœº - ç»ˆææµç•…ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- 1. åŸºç¡€è®¾ç½® --- */
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; height: 100vh; width: 100vw; user-select: none; -webkit-touch-callout: none; }
        
        /* æ¡Œé¢èƒŒæ™¯ */
        #table {
            position: relative; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1b5e20 0%, #05220a 100%);
            box-shadow: inset 0 0 100px #000;
            display: flex; justify-content: center; align-items: center;
        }
        /* æ¡Œå¸ƒçº¹ç† */
        #table::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/felt.png');
            opacity: 0.4; pointer-events: none;
        }

        /* --- 2. æ ¸å¿ƒç»„ä»¶ --- */
        /* 3D æ‰‘å…‹ç‰Œ */
        .card-wrapper {
            width: 46px; height: 68px; position: absolute;
            transform-style: preserve-3d; transition: transform 0.6s, top 0.5s, left 0.5s;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.5); border-radius: 4px; z-index: 20;
        }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 4px; display: flex; justify-content: center; align-items: center;
            font-size: 22px; font-weight: bold; background: #fff; border: 1px solid #ccc;
        }
        .card-back {
            background: #b71c1c; 
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 2px, transparent 2px, transparent 4px);
            border: 2px solid #eee; transform: rotateY(180deg);
        }
        .card-front { transform: rotateY(0deg); color: #000; }
        .card-front.red { color: #d32f2f; }

        /* ç‰Œå † */
        #deck-pile {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            width: 46px; height: 68px; background: #b71c1c; border-radius: 4px;
            box-shadow: -2px 2px 0 #8b0000, -4px 4px 0 #8b0000, 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* åº•æ±  */
        #pot-area {
            position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.3); padding: 5px 20px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); text-align: center;
        }
        .pot-val { color: #f1c40f; font-size: 24px; font-weight: 800; text-shadow: 0 2px 4px black; }
        .pot-label { color: #aaa; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; }

        /* --- 3. ç©å®¶åº§ä½ --- */
        .seat { position: absolute; width: 100px; height: 120px; z-index: 10; display: flex; flex-direction: column; align-items: center; transition: opacity 0.3s; }
        /* 2äººå¸ƒå±€ */
        .seat-bottom { bottom: 120px; left: 50%; transform: translateX(-50%); } 
        .seat-top { top: 50px; left: 50%; transform: translateX(-50%); }    
        /* 4äººå¸ƒå±€ */
        .seat-left { top: 50%; left: 10px; transform: translateY(-50%); }
        .seat-right { top: 50%; right: 10px; transform: translateY(-50%); }

        .avatar {
            width: 50px; height: 50px; background: #333; border-radius: 50%; 
            border: 3px solid #555; display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #fff; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        .avatar.active { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; animation: pulse-border 1.5s infinite; }
        
        .player-info { text-align: center; margin-top: 5px; color: white; text-shadow: 0 1px 3px black; width: 120px; }
        .chips-tag { color: #f1c40f; font-weight: bold; font-size: 14px; background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 10px; display: inline-block;}
        
        /* çŠ¶æ€æ ‡è®° */
        .status-badge { 
            position: absolute; top: -10px; right: -10px;
            font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 15;
        }
        .badge-blind { background: #546e7a; border: 1px solid #78909c; }
        .badge-seen { background: #f39c12; border: 1px solid #f1c40f; color: black; }
        .badge-fold { background: #c0392b; opacity: 0.8; }

        /* æ‰‹ç‰ŒåŒº */
        .hand-zone { position: relative; width: 80px; height: 50px; margin-top: 5px; pointer-events: none;}

        /* --- 4. åº•éƒ¨æ“ä½œé¢æ¿ (é‡æ„) --- */
        #dashboard {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; /* ç¡®ä¿å±‚çº§æœ€é«˜ */
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* æç¤ºæ¡ */
        #game-tip { 
            font-size: 12px; color: #aaa; margin-bottom: 8px; 
            width: 100%; text-align: center; height: 16px;
        }
        #game-tip.your-turn { color: #2ecc71; font-weight: bold; animation: pulse 1s infinite; }

        /* å•è¡Œæ§åˆ¶æ  */
        .control-bar {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 0 10px; box-sizing: border-box;
        }

        /* åŠŸèƒ½æŒ‰é’® */
        .btn-func {
            height: 44px; padding: 0 12px; border-radius: 6px; border: none; font-weight: bold; font-size: 13px;
            color: white; cursor: pointer; transition: transform 0.1s; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.1;
            min-width: 50px;
        }
        .btn-func:active { transform: scale(0.95); }
        .btn-func:disabled { background: #333 !important; color: #666; opacity: 0.5; filter: grayscale(1); }
        
        .btn-fold { background: #c0392b; box-shadow: 0 3px 0 #922b21; }
        .btn-look { background: #f39c12; color: #222; box-shadow: 0 3px 0 #d68910; }
        .btn-comp { background: #8e44ad; box-shadow: 0 3px 0 #6c3483; }

        /* åˆ†å‰²çº¿ */
        .divider { width: 1px; height: 30px; background: rgba(255,255,255,0.2); margin: 0 5px; }

        /* ç­¹ç æŒ‰é’® */
        .chip-btn {
            width: 44px; height: 44px; border-radius: 50%;
            border: 3px dashed rgba(255,255,255,0.5);
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: 900; color: white; cursor: pointer;
            position: relative; box-shadow: 0 3px 5px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        .chip-btn:active { transform: scale(0.9); }
        .chip-btn.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        
        .c-5 { background: #c0392b; border-color: #e74c3c; } 
        .c-10 { background: #2980b9; border-color: #3498db; } 
        .c-20 { background: #27ae60; border-color: #2ecc71; } 
        .c-50 { background: #8e44ad; border-color: #9b59b6; } 
        .c-100 { background: #f39c12; border-color: #f1c40f; color: black; }

        .cost-tag { 
            position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            font-size: 9px; background: rgba(0,0,0,0.8); padding: 1px 4px; border-radius: 4px; white-space: nowrap;
        }

        /* --- 5. å¼¹çª—ä¸åŠ¨ç”» --- */
        #anim-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        
        #lobby-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 5000;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: #fff;
        }
        input { padding: 15px; font-size: 18px; border-radius: 8px; border: none; text-align: center; margin: 15px; background: #333; color: white; width: 70%;}
        
        .big-btn { padding: 15px 40px; font-size: 18px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; margin: 10px; width: 80%; max-width: 300px; transition: 0.2s;}
        .big-btn:active { transform: scale(0.98); }

        #toast {
            position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #f1c40f; padding: 12px 30px;
            border: 1px solid #f1c40f; border-radius: 30px; display: none; z-index: 6000; font-weight: bold; text-align: center;
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); } 100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="lobby-modal">
    <h1 style="color:#f1c40f; margin-bottom: 0;">ğŸ›ï¸ çš‡å®¶èµŒåœº</h1>
    <p style="color:#666; font-size: 12px; margin-bottom: 40px;">v5.0 ç»ˆææµç•…ç‰ˆ</p>
    
    <div id="lobby-main" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <button class="big-btn" style="background:#2980b9; color: white;" onclick="initHost()">æˆ‘æ˜¯æˆ¿ä¸» (åˆ›å»º)</button>
        <div style="margin: 10px; color:#444">æˆ–è€…</div>
        <input type="text" id="join-id" placeholder="ç²˜è´´æˆ¿ä¸»ID">
        <button class="big-btn" style="background:#27ae60; color: white;" onclick="initGuest()">åŠ å…¥æˆ¿é—´</button>
    </div>

    <div id="lobby-wait" style="display:none; text-align:center; width: 100%; display: flex; flex-direction: column; align-items: center;">
        <p style="color:#aaa">æˆ¿é—´ID (ç‚¹å‡»å¤åˆ¶):</p>
        <input type="text" id="my-id-disp" readonly onclick="copyId()" style="background:#fff; color:#000; font-weight:bold;">
        <div id="player-status" style="margin: 20px; color: #ccc;">ç­‰å¾…ç©å®¶åŠ å…¥...</div>
        <button id="btn-start" class="big-btn" style="background:#f39c12; color:black; opacity: 0.5; pointer-events: none;" onclick="startGame()">
            ç­‰å¾…åŠ å…¥...
        </button>
    </div>
</div>

<div id="table">
    <div id="deck-pile"></div>
    <div id="pot-area">
        <div class="pot-val" id="pot-val">0</div>
        <div class="pot-label">Total Pot</div>
    </div>
    <div id="seats-container"></div>
    <div id="anim-layer"></div>

    <div id="dashboard">
        <div id="game-tip">ç­‰å¾…å¼€å§‹...</div>
        
        <div class="control-bar">
            <button id="btn-fold" class="btn-func btn-fold" disabled onclick="userAct('fold')">å¼ƒç‰Œ<br><span style="font-size:9px; font-weight:normal;">Fold</span></button>
            <button id="btn-look" class="btn-func btn-look" disabled onclick="userAct('look')">çœ‹ç‰Œ<br><span style="font-size:9px; font-weight:normal;">Look</span></button>
            <button id="btn-comp" class="btn-func btn-comp" disabled onclick="userAct('comp')">æ¯”ç‰Œ<br><span style="font-size:9px; font-weight:normal;" id="comp-price">100</span></button>
            
            <div class="divider"></div>
            
            <div class="chip-btn c-5 disabled" id="chip-5" onclick="userBet(5)">5<div class="cost-tag" id="tag-5">5</div></div>
            <div class="chip-btn c-10 disabled" id="chip-10" onclick="userBet(10)">10<div class="cost-tag" id="tag-10">10</div></div>
            <div class="chip-btn c-20 disabled" id="chip-20" onclick="userBet(20)">20<div class="cost-tag" id="tag-20">20</div></div>
            <div class="chip-btn c-50 disabled" id="chip-50" onclick="userBet(50)">50<div class="cost-tag" id="tag-50">50</div></div>
            <div class="chip-btn c-100 disabled" id="chip-100" onclick="userBet(100)">1h<div class="cost-tag" id="tag-100">100</div></div>
        </div>
    </div>
</div>

<div id="toast">æç¤ºä¿¡æ¯</div>

<script>
    // --- é…ç½®ä¸çŠ¶æ€ ---
    const PEER_CONF = { config: { 'iceServers': [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.qq.com:3478' } ] } };
    const $ = id => document.getElementById(id);
    const toast = m => { $('toast').innerText=m; $('toast').style.display='block'; setTimeout(()=>$('toast').style.display='none',2000); }
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const INIT_CHIPS = 2000;

    let peer, conn, conns = []; 
    let myPid = -1, isHost = false, playerCount = 1;
    let state = { phase: 'lobby', pot: 0, turn: 0, dealer: 0, players: [] };

    // --- ç½‘ç»œè¿æ¥ ---
    function initHost() {
        isHost = true; myPid = 0;
        $('lobby-main').style.display='none'; $('lobby-wait').style.display='flex';
        peer = new Peer(null, PEER_CONF);
        peer.on('open', id => $('my-id-disp').value = id);
        peer.on('connection', c => {
            conns.push(c);
            c.on('open', () => {
                c.send({t:'WELCOME', pid: conns.length});
                playerCount++;
                updateLobbyStatus();
            });
            c.on('data', d => handleDataHost(d, conns.indexOf(c) + 1));
            c.on('close', () => location.reload());
        });
    }

    function initGuest() {
        const dest = $('join-id').value.trim();
        if(!dest) return toast("è¯·è¾“å…¥ID");
        peer = new Peer(null, PEER_CONF);
        peer.on('open', () => {
            conn = peer.connect(dest);
            conn.on('data', handleDataGuest);
            conn.on('close', () => alert("è¿æ¥æ–­å¼€"));
        });
    }

    function updateLobbyStatus() {
        $('player-status').innerText = `å½“å‰äººæ•°: ${playerCount} (å«æˆ¿ä¸»)`;
        if(playerCount >= 2) {
            const btn = $('btn-start');
            btn.innerHTML = "ğŸš€ äººé½äº†ï¼Œå¼€å§‹æ¸¸æˆ";
            btn.style.opacity = 1;
            btn.style.pointerEvents = 'auto';
            btn.style.background = '#27ae60';
        }
    }

    // --- æ•°æ®å¤„ç† ---
    function handleDataGuest(d) {
        if(d.t === 'WELCOME') {
            myPid = d.pid;
            $('lobby-main').style.display='none'; 
            $('lobby-main').innerHTML = "<h2 style='color:#2ecc71; margin-top:50px;'>âœ… å·²è¿æ¥ï¼<br>ç­‰å¾…æˆ¿ä¸»å¼€å§‹...</h2>";
            $('lobby-main').style.display='block'; 
        }
        if(d.t === 'SYNC') {
            state = d.state;
            playerCount = state.players.length;
            $('lobby-modal').style.display = 'none'; // æ”¶åˆ°åŒæ­¥ä¿¡å·ï¼Œå…³é—­å¤§å…
            renderSeats();
            renderUI();
        }
        if(d.t === 'ANIM_DEAL') playDealAnim(d.toPid, d.cardIdx);
        if(d.t === 'ANIM_CHIP') playChipAnim(d.pid, d.val);
        if(d.t === 'TOAST') toast(d.msg);
    }

    function handleDataHost(d, fromPid) {
        if(d.t === 'ACT') processAction(fromPid, d.act, d.val);
    }

    function broadcast(msg) {
        conns.forEach(c => c.send(msg));
    }

    // --- æ¸¸æˆé€»è¾‘ (Host) ---
    async function startGame() {
        $('lobby-modal').style.display = 'none';
        
        // åˆå§‹åŒ–ç©å®¶æ•°æ®
        for(let i=0; i<playerCount; i++) {
            state.players[i] = { chips: INIT_CHIPS, hand: [], status: 'play', seen: false, folded: false };
        }
        state.phase = 'game';
        // å¼ºåˆ¶åˆå§‹åŒ–å›åˆï¼šæˆ¿ä¸»å…ˆæ‰‹
        state.turn = 0; 
        state.dealer = -1; // è¿™æ · startNewRound å dealer=0

        broadcast({t:'SYNC', state: state});
        renderSeats();
        startNewRound();
    }

    async function startNewRound() {
        const suits = ['â™ ','â™¥','â™£','â™¦'];
        const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        let deck = [];
        suits.forEach(s => ranks.forEach(r => deck.push({s,r})));
        deck.sort(() => Math.random() - 0.5);

        state.pot = 0;
        state.dealer = (state.dealer + 1) % playerCount;
        // åº„å®¶çš„ä¸‹å®¶å…ˆè¯´è¯
        state.turn = (state.dealer + 1) % playerCount; 
        
        state.players.forEach(p => {
            if(p.chips > 0) {
                p.status = 'play'; 
                p.hand = [deck.pop(), deck.pop(), deck.pop()];
                p.seen = false; p.folded = false;
            } else p.status = 'lost';
        });

        broadcast({t:'SYNC', state: state});
        
        // å‘ç‰ŒåŠ¨ç”» (ä¾æ¬¡å‘)
        for(let c=0; c<3; c++) {
            for(let p=0; p<playerCount; p++) {
                const pid = (state.dealer + 1 + p) % playerCount;
                if(state.players[pid].status === 'play') {
                    broadcast({t:'ANIM_DEAL', toPid: pid, cardIdx: c});
                    playDealAnim(pid, c);
                    await sleep(150);
                }
            }
        }
        broadcast({t:'TOAST', msg:"å‘ç‰Œå®Œæ¯•ï¼Œè¯·ä¸‹æ³¨ï¼"});
    }

    function processAction(pid, act, baseVal) {
        if(state.turn !== pid) return;
        const p = state.players[pid];
        
        let actualCost = baseVal;
        // å¦‚æœæ˜¯è·Ÿæ³¨(bet)ä¸”å·²çœ‹ç‰Œï¼Œç¿»å€
        if(act === 'bet' && p.seen) actualCost = baseVal * 2;
        // å¦‚æœæ˜¯æ¯”ç‰Œ(comp)ï¼ŒåŸºç¡€100ï¼Œçœ‹ç‰Œ200
        if(act === 'comp') {
            const base = 100;
            actualCost = p.seen ? base * 2 : base;
        }

        if(act === 'fold') {
            p.folded = true; p.status = 'fold';
        } else if (act === 'look') {
            p.seen = true;
            broadcast({t:'SYNC', state: state});
            return; // çœ‹ç‰Œä¸åˆ‡å›åˆ
        } else if (act === 'bet') {
            if(p.chips >= actualCost) {
                p.chips -= actualCost; state.pot += actualCost;
                broadcast({t:'ANIM_CHIP', pid: pid, val: baseVal}); 
                playChipAnim(pid, baseVal);
            }
        } else if (act === 'comp') {
            if(p.chips >= actualCost) {
                p.chips -= actualCost; state.pot += actualCost;
                endRound(pid); // ç®€åŒ–ï¼šä¸»åŠ¨æ¯”ç‰Œè€…èµ¢
                return;
            }
        }

        // åˆ‡æ¢ä¸‹ä¸€ä½
        let loop = 0;
        do {
            state.turn = (state.turn + 1) % playerCount;
            loop++;
        } while(state.players[state.turn].status !== 'play' && loop < playerCount);

        // æ£€æŸ¥æ˜¯å¦åªå‰©ä¸€äºº
        const active = state.players.filter(p => p.status === 'play');
        if(active.length === 1) endRound(state.players.indexOf(active[0]));
        else broadcast({t:'SYNC', state: state});
    }

    function endRound(winnerPid) {
        state.players[winnerPid].chips += state.pot;
        // æ‘Šç‰Œ
        state.players.forEach(p => p.seen = true);
        broadcast({t:'SYNC', state: state});
        broadcast({t:'TOAST', msg:`ğŸ† ç©å®¶ ${winnerPid+1} èµ¢äº† ${state.pot}ï¼`});
        setTimeout(() => { if(isHost) startNewRound(); }, 4000);
    }

    // --- å®¢æˆ·ç«¯äº¤äº’ ---
    function userBet(baseVal) {
        if(state.turn !== myPid) return;
        const p = state.players[myPid];
        const cost = p.seen ? baseVal * 2 : baseVal;
        if(p.chips < cost) return toast("ç­¹ç ä¸è¶³");
        
        if(isHost) processAction(myPid, 'bet', baseVal);
        else conn.send({t:'ACT', act:'bet', val: baseVal});
    }

    function userAct(act) {
        if(state.turn !== myPid) return;
        if(isHost) processAction(myPid, act);
        else conn.send({t:'ACT', act: act});
    }

    // --- UI æ¸²æŸ“ ---
    function renderSeats() {
        const container = $('seats-container');
        container.innerHTML = '';
        for(let i=0; i<playerCount; i++) {
            let posClass = '';
            const relIdx = (i - myPid + playerCount) % playerCount;
            if(playerCount === 2) posClass = relIdx === 0 ? 'seat-bottom' : 'seat-top';
            else {
                if(relIdx === 0) posClass = 'seat-bottom';
                else if(relIdx === 1) posClass = 'seat-right';
                else if(relIdx === 2) posClass = 'seat-top';
                else posClass = 'seat-left';
            }

            const div = document.createElement('div');
            div.className = `seat ${posClass}`;
            div.id = `seat-${i}`;
            div.innerHTML = `
                <div class="avatar" id="avt-${i}">P${i+1}
                    <div class="status-badge badge-blind" id="badge-${i}">ğŸ™ˆ</div>
                </div>
                <div class="player-info">
                    <div class="chips-tag">ğŸ’° <span id="chips-${i}">${INIT_CHIPS}</span></div>
                </div>
                <div class="hand-zone" id="hand-${i}"></div>
            `;
            container.appendChild(div);
        }
    }

    function renderUI() {
        $('pot-val').innerText = state.pot;

        // æ›´æ–°ç©å®¶
        state.players.forEach((p, i) => {
            $(`chips-${i}`).innerText = p.chips;
            const badge = $(`badge-${i}`);
            const avt = $(`avt-${i}`);
            
            // çŠ¶æ€æ ‡
            if(p.folded) { badge.className='status-badge badge-fold'; badge.innerText='å¼ƒ'; }
            else if(p.seen) { badge.className='status-badge badge-seen'; badge.innerText='ğŸ‘€'; }
            else { badge.className='status-badge badge-blind'; badge.innerText='ğŸ™ˆ'; }

            // é«˜äº®
            if(i === state.turn) avt.classList.add('active'); else avt.classList.remove('active');

            // æ‰‹ç‰Œ
            const zone = $(`hand-${i}`);
            if(zone.children.length === 3) {
                const show = (i === myPid && p.seen) || p.seen;
                Array.from(zone.children).forEach((w, idx) => {
                    if(show && !p.folded) {
                        const c = p.hand[idx];
                        w.querySelector('.card-back').style.transform = "rotateY(0deg)";
                        const f = w.querySelector('.card-front');
                        f.style.transform = "rotateY(0deg)";
                        f.className = `card-face card-front ${['â™¥','â™¦'].includes(c.s)?'red':''}`;
                        f.innerText = c.s + c.r;
                    }
                });
            }
        });

        // åº•éƒ¨æ§åˆ¶
        const me = state.players[myPid];
        const isTurn = (state.turn === myPid) && me.status === 'play';
        
        // æç¤ºè¯­
        const tip = $('game-tip');
        if(me.folded) { tip.innerText = "å·²å¼ƒç‰Œï¼Œç­‰å¾…ä¸‹ä¸€å±€"; tip.className=''; }
        else if(isTurn) { 
            tip.innerText = me.seen ? "è½®åˆ°ä½ äº† (å·²çœ‹ç‰Œï¼Œä¸‹æ³¨ç¿»å€)" : "è½®åˆ°ä½ äº† (é—·ç‰Œä¸­ï¼Œä¸‹æ³¨åŠä»·)";
            tip.className = 'your-turn';
        } else {
            tip.innerText = `ç­‰å¾… P${state.turn+1} è¡ŒåŠ¨...`; tip.className='';
        }

        // æŒ‰é’®è§£é”
        $('btn-fold').disabled = !isTurn;
        $('btn-look').disabled = !isTurn || me.seen;
        $('btn-comp').disabled = !isTurn;
        $('comp-price').innerText = me.seen ? "200" : "100"; // æ¯”ç‰Œä»·æ ¼

        // ç­¹ç è§£é”ä¸ä»·æ ¼æ›´æ–°
        [5, 10, 20, 50, 100].forEach(val => {
            const btn = $(`chip-${val}`);
            const tag = $(`tag-${val}`);
            if(isTurn) {
                btn.classList.remove('disabled');
                const cost = me.seen ? val * 2 : val;
                tag.innerText = me.seen ? `-${cost}` : `${val}`;
                tag.style.background = me.seen ? '#c0392b' : 'rgba(0,0,0,0.8)';
            } else {
                btn.classList.add('disabled');
                tag.innerText = val;
            }
        });
    }

    // --- åŠ¨ç”» ---
    function playDealAnim(pid, cIdx) {
        const deck = $('deck-pile').getBoundingClientRect();
        const w = document.createElement('div');
        w.className = 'card-wrapper';
        w.innerHTML = `<div class="card-face card-front"></div><div class="card-face card-back" style="transform: rotateY(0deg);"></div>`;
        $('anim-layer').appendChild(w);
        
        // åˆå§‹ä½ç½®
        w.style.left = deck.left + 'px'; w.style.top = deck.top + 'px';
        
        // ç›®æ ‡ä½ç½®
        const zone = $(`hand-${pid}`).getBoundingClientRect();
        const targetX = zone.left + 15 + cIdx*25;
        const targetY = zone.top + 5;

        // è§¦å‘åŠ¨ç”»
        setTimeout(() => {
            w.style.left = targetX + 'px';
            w.style.top = targetY + 'px';
            w.style.transform = `rotate(${(cIdx-1)*5}deg)`;
        }, 10);

        // å½’ä½
        setTimeout(() => {
            w.remove();
            const staticW = w.cloneNode(true);
            staticW.style.position = 'absolute';
            staticW.style.left = (15 + cIdx*25) + 'px';
            staticW.style.top = '5px';
            staticW.querySelector('.card-back').style.transform = "rotateY(0deg)";
            staticW.querySelector('.card-front').style.transform = "rotateY(180deg)";
            $(`hand-${pid}`).appendChild(staticW);
        }, 600);
    }

    function playChipAnim(pid, val) {
        const c = document.createElement('div');
        c.className = `chip-btn c-${val}`;
        c.innerText = val;
        c.style.position = 'absolute';
        c.style.border = 'none'; c.style.boxShadow='none';
        $('anim-layer').appendChild(c);

        const seat = $(`seat-${pid}`).getBoundingClientRect();
        c.style.left = (seat.left + 50) + 'px';
        c.style.top = (seat.top + 50) + 'px';

        const pot = $('pot-area').getBoundingClientRect();
        const rx = Math.random()*100 - 50;
        const ry = Math.random()*40 - 20;

        setTimeout(() => {
            c.style.transition = "all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            c.style.left = (pot.left + pot.width/2 + rx) + 'px';
            c.style.top = (pot.top + pot.height/2 + ry) + 'px';
            c.style.transform = `scale(0.6) rotate(${Math.random()*360}deg)`;
        }, 10);
    }

    function copyId() { $('my-id-disp').select(); document.execCommand('copy'); toast("å·²å¤åˆ¶"); }
</script>
</body>
</html>
