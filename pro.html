<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››äººçš‡å®¶èµŒæ¡Œç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒåœºæ™¯æ ·å¼ --- */
        :root { --felt-color: #0a5f38; --border-color: #5e3c1a; }
        body { margin: 0; padding: 0; overflow: hidden; background: #111; font-family: 'Helvetica Neue', sans-serif; user-select: none; -webkit-touch-callout: none; height: 100vh; width: 100vw; }
        
        /* èµŒæ¡ŒèƒŒæ™¯ */
        #table {
            position: relative; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #0c7a46 0%, var(--felt-color) 80%);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
        }
        /* æ¡Œæ²¿çº¹ç† */
        #table::before {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 8px solid var(--border-color); border-radius: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 5px 10px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        /* --- é€šç”¨ç»„ä»¶ --- */
        /* æ‰‘å…‹ç‰Œ */
        .card { width: 46px; height: 70px; background: white; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); position: relative; font-weight: bold; font-size: 20px; display: flex; justify-content: center; align-items: center; border: 1px solid #ccc; transition: transform 0.3s; }
        .card.red { color: #c0392b; }
        .card.back { background: #34495e; border: 2px solid #fff; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 5px, transparent 5px, transparent 10px); color: transparent; }
        .card.folded { filter: grayscale(0.8) brightness(0.7); }

        /* ç­¹ç æ ·å¼ */
        .chip { width: 36px; height: 36px; border-radius: 50%; border: 4px dashed white; box-shadow: 0 3px 5px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 12px; color: white; position: absolute; transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .chip-10 { background: #2980b9; border-color: #3498db; }
        .chip-50 { background: #27ae60; border-color: #2ecc71; }
        .chip-100 { background: #c0392b; border-color: #e74c3c; }
        .chip-stack { position: relative; width: 40px; height: 40px; } /* ç­¹ç å †å®¹å™¨ */
        .chip-stack .chip { position: absolute; top: 0; left: 0; } /* å †å æ•ˆæœ */

        /* è™šæ‹Ÿæ‰‹åŠ¨ç”» */
        #virtual-hand {
            position: fixed; width: 100px; height: 120px; 
            background: url('https://i.imgur.com/8Y8yZ9C.png') no-repeat center center / contain; /* è¿™é‡Œç”¨ä¸€ä¸ªç®€å•çš„æ‰‹å›¾ç‰‡å ä½ */
            z-index: 999; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        /* åŠ¨ç”»å…³é”®å¸§ï¼šä»ç©å®¶å¤„ç§»åŠ¨åˆ°æ¡Œä¸­å¤® */
        @keyframes push-chips {
            0% { transform: translate(var(--start-x), var(--start-y)) scale(0.8); opacity: 1; }
            60% { transform: translate(var(--end-x), var(--end-y)) scale(1); opacity: 1; }
            100% { transform: translate(var(--end-x), var(--end-y)) scale(1); opacity: 0; }
        }

        /* --- å¸ƒå±€åŒºåŸŸ --- */
        /* åº•æ± åŒºåŸŸ */
        #pot-area { position: absolute; display: flex; flex-direction: column; align-items: center; }
        #pot-chips { position: relative; width: 120px; height: 60px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
        .pot-label { color: #f1c40f; background: rgba(0,0,0,0.5); padding: 4px 15px; border-radius: 20px; font-size: 14px; margin-top: 5px; border: 1px solid #f1c40f; }

        /* ç©å®¶åŒºåŸŸ (ä¸Š, ä¸‹, å·¦, å³) */
        .player-seat { position: absolute; display: flex; flex-direction: column; align-items: center; width: 200px; transition: opacity 0.3s; }
        .seat-bottom { bottom: 90px; left: 50%; transform: translateX(-50%); } /* è‡ªå·± */
        .seat-top { top: 30px; left: 50%; transform: translateX(-50%); } /* å¯¹å®¶ */
        .seat-left { top: 50%; left: 40px; transform: translateY(-50%); align-items: flex-start; }
        .seat-right { top: 50%; right: 40px; transform: translateY(-50%); align-items: flex-end; }

        /* ç©å®¶ä¿¡æ¯é¢æ¿ */
        .player-info { background: rgba(0,0,0,0.6); padding: 8px; border-radius: 8px; text-align: center; color: white; border: 2px solid transparent; position: relative; }
        .player-info.active { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; } /* å½“å‰è¡ŒåŠ¨ç©å®¶é«˜äº® */
        .player-name { font-size: 14px; font-weight: bold; margin-bottom: 4px; }
        .player-status { font-size: 10px; background: #555; padding: 2px 6px; border-radius: 4px; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); white-space: nowrap;}

        /* èº«å‰ç­¹ç å † */
        .my-chips-pile { margin: 10px 0; display: flex; gap: 5px; }

        /* æ‰‹ç‰ŒåŒº */
        .cards-container { display: flex; gap: 4px; margin: 10px 0; perspective: 1000px; }

        /* --- UIæ§ä»¶ --- */
        /* å¤§å…è¿æ¥å±‚ */
        #lobby-layer { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .lobby-box { background: #2c3e50; padding: 30px; border-radius: 15px; text-align: center; border: 2px solid #34495e; }
        input, button { padding: 10px 15px; margin: 5px; border-radius: 5px; border: none; font-size: 14px; }
        .btn-gold { background: #f1c40f; color: #4a3400; font-weight: bold; cursor: pointer; }
        
        /* åº•éƒ¨æ“ä½œæ  */
        #controls-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; gap: 15px; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .btn-act { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-weight: bold; position: relative; box-shadow: 0 4px 0 rgba(0,0,0,0.5); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12px; }
        .btn-act:active { transform: translateY(4px); box-shadow: none; }
        .btn-act:disabled { filter: grayscale(1); opacity: 0.4; cursor: not-allowed; }
        .c-fold { background: #c0392b; } .c-look { background: #2980b9; } .c-call { background: #27ae60; } .c-raise { background: #e67e22; }
        .bet-tag { position: absolute; top: -8px; background: #f1c40f; color: black; font-size: 10px; padding: 1px 5px; border-radius: 4px; border: 1px solid #000; white-space: nowrap;}

        /* åŠ æ³¨é€‰æ‹©é¢æ¿ (å¼¹å‡ºå¼) */
        #raise-panel { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); padding: 15px; border-radius: 10px; border: 2px solid #f1c40f; display: none; z-index: 1100; flex-direction: column; align-items: center;}
        .raise-opts { display: flex; gap: 10px; margin-bottom: 10px; }
        .chip-btn { width: 50px; height: 50px; border-radius: 50%; border: 3px dashed white; box-shadow: 0 3px 5px black; cursor: pointer; font-weight: bold; color: white; display: flex; justify-content: center; align-items: center;}
        
        /* æ¶ˆæ¯æç¤º */
        #toast { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #f1c40f; padding: 10px 20px; border-radius: 8px; z-index: 3000; display: none; border: 1px solid #f1c40f; font-weight: bold;}
    </style>
</head>
<body>

<div id="virtual-hand"></div>
<div id="toast">æç¤º</div>

<div id="table">
    <div id="pot-area">
        <div id="pot-chips"></div>
        <div class="pot-label">åº•æ± : <span id="pot-val">0</span> (å•æ³¨:<span id="base-val">10</span>)</div>
    </div>

    <div class="player-seat seat-top" id="seat-2">
        <div class="cards-container" id="cards-2"></div>
        <div class="player-info">
            <span class="player-status" id="status-2">ç­‰å¾…</span>
            <div class="player-name">ç©å®¶ 2</div>
            <div>ğŸ’° <span id="chips-2">1000</span></div>
        </div>
    </div>
    <div class="player-seat seat-left" id="seat-1">
        <div class="cards-container" id="cards-1"></div>
        <div class="player-info">
            <span class="player-status" id="status-1">ç­‰å¾…</span>
            <div class="player-name">ç©å®¶ 1</div>
            <div>ğŸ’° <span id="chips-1">1000</span></div>
        </div>
    </div>
    <div class="player-seat seat-right" id="seat-3">
        <div class="cards-container" id="cards-3"></div>
        <div class="player-info">
            <span class="player-status" id="status-3">ç­‰å¾…</span>
            <div class="player-name">ç©å®¶ 3</div>
            <div>ğŸ’° <span id="chips-3">1000</span></div>
        </div>
    </div>
    <div class="player-seat seat-bottom" id="seat-0">
        <div class="my-chips-pile" id="my-pile">
            </div>
        <div class="cards-container" id="cards-0">
            <div class="card back"></div><div class="card back"></div><div class="card back"></div>
        </div>
        <div class="player-info">
            <span class="player-status" id="status-0" style="background:#f1c40f; color:black;">å‡†å¤‡</span>
            <div class="player-name">æˆ‘è‡ªå·±</div>
            <div>ğŸ’° <span id="chips-0">1000</span></div>
        </div>
    </div>

</div>

<div id="controls-bar">
    <button class="btn-act c-fold" id="btn-fold" onclick="doAct('fold')">å¼ƒç‰Œ</button>
    <button class="btn-act c-look" id="btn-look" onclick="doAct('look')">çœ‹ç‰Œ</button>
    <button class="btn-act c-call" id="btn-call" onclick="doAct('call')">è·Ÿæ³¨<span class="bet-tag" id="tag-call">10</span></button>
    <button class="btn-act c-raise" id="btn-raise" onclick="toggleRaisePanel()">åŠ æ³¨...</button>
</div>

<div id="raise-panel">
    <div style="color:white; margin-bottom:10px;">é€‰æ‹©åŠ æ³¨é‡‘é¢ (åŸºç¡€æ³¨: <span id="raise-base">10</span>)</div>
    <div class="raise-opts">
        <div class="chip-btn chip-10" onclick="doAct('raise', 10)">+10</div>
        <div class="chip-btn chip-50" onclick="doAct('raise', 50)">+50</div>
        <div class="chip-btn chip-100" onclick="doAct('raise', 100)">+100</div>
    </div>
    <button class="btn-gold" onclick="toggleRaisePanel()" style="padding: 5px 20px;">å–æ¶ˆ</button>
</div>

<div id="lobby-layer">
    <div class="lobby-box" id="lobby-start">
        <h1 style="color:#f1c40f; margin:0;">â™£ï¸ çš‡å®¶èµŒæ¡Œ â™¦ï¸</h1>
        <p style="color:#bdc3c7; font-size:12px;">å››äººæ²‰æµ¸å¼ä½“éªŒç‰ˆ</p>
        <button class="btn-gold" style="width:80%; font-size:16px; padding:15px;" onclick="setupHost()">åˆ›å»ºæˆ¿é—´ (æˆ‘æ˜¯æˆ¿ä¸»)</button>
        <div style="margin:10px; color:rgba(255,255,255,0.3);">- æˆ– -</div>
        <input type="text" id="room-id" placeholder="è¾“å…¥æˆ¿ä¸» ID" style="text-align:center;">
        <button class="btn-gold" style="background:#27ae60; width:80%;" onclick="setupGuest()">åŠ å…¥æˆ¿é—´</button>
    </div>
    <div class="lobby-box" id="lobby-host" style="display:none;">
        <p>æˆ¿é—´ ID (å¤åˆ¶å‘ç»™ 3 ä½å¥½å‹):</p>
        <input type="text" id="my-id-disp" readonly style="font-family:monospace; background:white; color:black; width:250px; text-align:center;" onclick="this.select();document.execCommand('copy');toast('å·²å¤åˆ¶!')">
        <div id="host-list" style="text-align:left; margin-top:20px; color:#bdc3c7;">
            <div>ğŸ‘¤ ç©å®¶1 (æˆ¿ä¸»): å·²å°±ä½</div>
            <div id="p2-stat">ğŸ‘¤ ç©å®¶2: ç­‰å¾…åŠ å…¥...</div>
            <div id="p3-stat">ğŸ‘¤ ç©å®¶3: ç­‰å¾…åŠ å…¥...</div>
            <div id="p4-stat">ğŸ‘¤ ç©å®¶4: ç­‰å¾…åŠ å…¥...</div>
        </div>
        <button id="btn-start-game" class="btn-gold" style="margin-top:20px; background:#7f8c8d;" disabled onclick="startGame()">äººé½äº†ï¼Œå¼€å§‹å‘ç‰Œï¼</button>
    </div>
</div>

<script>
    // --- é…ç½® ---
    // ä½¿ç”¨å¤šä¸ªå…¬å…± STUN æœåŠ¡å™¨æé«˜è¿æ¥æˆåŠŸç‡
    const PEER_CFG = { config: { 'iceServers': [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.qq.com:3478' } ] } };
    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦']; const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    const VALS = {'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};

    // --- çŠ¶æ€ç®¡ç† (æ ¸å¿ƒ) ---
    let peer, myConn = null, hostConns = []; // hostConns å­˜å‚¨æˆ¿ä¸»ä¸3ä¸ªå®¢äººçš„è¿æ¥
    let myPid = -1; // æˆ‘çš„åº§ä½å· (0=æˆ¿ä¸», 1,2,3=å®¢äºº)
    let isHost = false;

    // æ¸¸æˆå…¨å±€çŠ¶æ€ (ç”±æˆ¿ä¸»ç»´æŠ¤å¹¶å¹¿æ’­)
    let state = {
        pot: 0, base: 10, turn: 0, // turn: å½“å‰è¡ŒåŠ¨ç©å®¶åº§ä½å·
        dealer: 0, // åº„å®¶
        phase: 'idle', // idle, playing, showdown
        players: [ // 4ä¸ªç©å®¶çš„æ•°æ®ç»“æ„
            { chips:1000, hand:[], status:'ready', bet:0, seen:false, folded:false },
            { chips:1000, hand:[], status:'wait', bet:0, seen:false, folded:false },
            { chips:1000, hand:[], status:'wait', bet:0, seen:false, folded:false },
            { chips:1000, hand:[], status:'wait', bet:0, seen:false, folded:false }
        ]
    };

    // --- å·¥å…·å‡½æ•° ---
    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
    function getSeatId(pid) { 
        // æ ¹æ®æˆ‘çš„è§†è§’ï¼Œè®¡ç®—å…¶ä»–äººçš„ç›¸å¯¹åº§ä½ (ä¿è¯è‡ªå·±æ°¸è¿œåœ¨æœ€ä¸‹é¢ seat-0)
        return (pid - myPid + 4) % 4; 
    }

    // --- ç½‘ç»œè¿æ¥é€»è¾‘ (æ˜Ÿå‹ç»“æ„: 1 Host <-> 3 Guests) ---

    // 1. æˆ¿ä¸»æµç¨‹
    function setupHost() {
        isHost = true; myPid = 0;
        document.getElementById('lobby-start').style.display = 'none';
        document.getElementById('lobby-host').style.display = 'block';
        peer = new Peer(null, PEER_CFG);
        peer.on('open', id => document.getElementById('my-id-disp').value = id);
        peer.on('connection', conn => {
            // é™åˆ¶æœ€å¤š3ä¸ªè¿æ¥
            if(hostConns.length >= 3) { conn.close(); return; }
            hostConns.push(conn);
            const newPid = hostConns.length; // åˆ†é…åº§ä½å· 1, 2, 3
            document.getElementById(`p${newPid+1}-stat`).innerText = `ğŸ‘¤ ç©å®¶${newPid+1}: å·²è¿æ¥!`;
            
            conn.on('open', () => {
                // è¿æ¥å»ºç«‹åï¼Œå‘é€åˆ†é…çš„åº§ä½å·ç»™å®¢äºº
                conn.send({ t:'WELCOME', pid: newPid });
                // æ£€æŸ¥æ˜¯å¦äººé½
                if(hostConns.length === 3) {
                    const btn = document.getElementById('btn-start-game');
                    btn.disabled = false; btn.style.background = '#f1c40f'; btn.innerText = "äººé½äº†ï¼Œå¼€å§‹å‘ç‰Œï¼";
                    toast("äººé½äº†ï¼æˆ¿ä¸»å¯ä»¥å¼€å§‹äº†ã€‚");
                }
            });
            conn.on('data', d => handleDataHost(d, newPid)); // å¤„ç†å®¢äººå‘æ¥çš„æ•°æ®
            conn.on('close', () => alert(`ç©å®¶${newPid+1}æ–­å¼€äº†è¿æ¥ï¼Œè¯·åˆ·æ–°é‡å»ºã€‚`));
        });
    }

    // 2. å®¢äººæµç¨‹
    function setupGuest() {
        const dest = document.getElementById('room-id').value.trim();
        if(!dest) return toast("è¯·è¾“å…¥æˆ¿ä¸»ID");
        toast("æ­£åœ¨è¿æ¥æˆ¿ä¸»...");
        peer = new Peer(null, PEER_CFG);
        peer.on('open', () => {
            myConn = peer.connect(dest, {reliable:true});
            myConn.on('data', handleDataGuest);
            myConn.on('close', () => alert("ä¸æˆ¿ä¸»æ–­å¼€è¿æ¥"));
        });
    }

    // 3. æ•°æ®å¤„ç†
    function handleDataGuest(d) {
        if(d.t === 'WELCOME') { // æ”¶åˆ°åº§ä½åˆ†é…
            myPid = d.pid;
            document.getElementById('lobby-layer').style.display = 'none'; // è¿›å…¥æ¸¸æˆç•Œé¢
            renderUI(); // åˆå§‹æ¸²æŸ“
            toast(`åŠ å…¥æˆåŠŸï¼ä½ æ˜¯ç©å®¶ ${myPid+1}`);
        }
        if(d.t === 'STATE') { // æ”¶åˆ°çŠ¶æ€åŒæ­¥
            state = d.pl;
            renderUI(); 
            // å¦‚æœæœ‰åŠ¨ç”»æŒ‡ä»¤ï¼Œæ‰§è¡ŒåŠ¨ç”»
            if(d.anim) playAnimation(d.anim);
        }
    }

    function handleDataHost(d, fromPid) {
        // æˆ¿ä¸»å¤„ç†å®¢äººçš„åŠ¨ä½œè¯·æ±‚
        if(d.t === 'ACT') processAction(fromPid, d.act, d.val);
    }

    // --- æ¸¸æˆé€»è¾‘ (ä»…æˆ¿ä¸»æ‰§è¡Œ) ---

    function startGame() {
        if(!isHost) return;
        // éšè—å¤§å…ï¼Œå¹¿æ’­å¼€å§‹ä¿¡å·
        document.getElementById('lobby-layer').style.display = 'none';
        hostConns.forEach(c => c.send({t:'STATE', pl:state})); // å…ˆåŒæ­¥ä¸€æ¬¡ç©ºçŠ¶æ€è¿›å…¥ç•Œé¢
        renderUI();
        setTimeout(dealNewGame, 1000); // å»¶è¿Ÿ1ç§’å‘ç‰Œ
    }

    function dealNewGame() {
        // æ´—ç‰Œ
        let deck = []; SUITS.forEach(s=>RANKS.forEach(r=>deck.push({s,r,v:VALS[r]})));
        deck.sort(()=>Math.random()-0.5);

        // é‡ç½®çŠ¶æ€
        state.pot = 0; state.base = 10; state.phase = 'playing';
        // è½®è½¬åº„å®¶å’Œå…ˆæ‰‹
        state.dealer = (state.dealer + 1) % 4;
        state.turn = (state.dealer + 1) % 4; 

        state.players.forEach((p, i) => {
            p.hand = [deck.pop(), deck.pop(), deck.pop()];
            p.seen = false; p.folded = false; p.bet = 0;
            p.status = 'playing';
            // å¼ºåˆ¶æ‰£åº•æ³¨
            if(p.chips >= 10) { p.chips -= 10; state.pot += 10; } else p.status = 'lost';
        });

        // å¹¿æ’­æ–°çŠ¶æ€ï¼Œå¹¶é™„å¸¦â€œå‘ç‰ŒåŠ¨ç”»â€æŒ‡ä»¤ï¼ˆæš‚æœªå®ç°å¤æ‚å‘ç‰Œï¼Œå…ˆåŒæ­¥ï¼‰
        broadcastState();
        toast(`æ–°å±€å¼€å§‹ï¼ç©å®¶${state.turn+1}å…ˆè¯´è¯ã€‚`);
    }

    function processAction(pid, act, val) {
        if(state.phase !== 'playing' || state.turn !== pid) return; // ä¸æ˜¯ä½ çš„å›åˆ

        const p = state.players[pid];
        let cost = 0;
        let animData = null; // è®°å½•åŠ¨ç”»ä¿¡æ¯

        switch(act) {
            case 'fold':
                p.folded = true; p.status = 'folded';
                checkGameOver(); // æ£€æŸ¥æ˜¯å¦åªå‰©ä¸€äºº
                break;
            case 'look':
                p.seen = true; // çœ‹ç‰Œä¸æ¶ˆè€—å›åˆ
                broadcastState(); return; 
            case 'call':
                cost = state.base * (p.seen ? 2 : 1);
                if(p.chips >= cost) {
                    p.chips -= cost; state.pot += cost;
                    // è®°å½•åŠ¨ç”»ï¼šè°åœ¨ä»€ä¹ˆä½ç½®åŠ äº†å¤šå°‘ç­¹ç 
                    animData = { type: 'bet', pid: pid, amount: cost };
                    nextTurn();
                }
                break;
            case 'raise':
                // val æ˜¯å¢åŠ çš„é¢åº¦ï¼Œæ–°çš„å•æ³¨ = å½“å‰å•æ³¨ + å¢åŠ é¢åº¦
                let newBase = state.base + val; 
                if(newBase > 200) newBase = 200; // å°é¡¶
                state.base = newBase;
                cost = state.base * (p.seen ? 2 : 1);
                if(p.chips >= cost) {
                    p.chips -= cost; state.pot += cost;
                    animData = { type: 'bet', pid: pid, amount: cost };
                    nextTurn();
                } else state.base -= val; // å›é€€
                break;
        }
        broadcastState(animData);
    }

    function nextTurn() {
        let loop = 0;
        do {
            state.turn = (state.turn + 1) % 4;
            loop++;
        } while (state.players[state.turn].status !== 'playing' && loop < 4);
    }

    function checkGameOver() {
        const active = state.players.filter(p => p.status === 'playing');
        if(active.length === 1) {
            // åªå‰©ä¸€äººè·èƒœ
            const winnerIndex = state.players.indexOf(active[0]);
            endRound(winnerIndex);
        } else {
            nextTurn();
        }
    }

    function endRound(winnerPid) {
        state.phase = 'showdown';
        state.players[winnerPid].chips += state.pot;
        state.winner = winnerPid;
        // æ‰€æœ‰äººæ‘Šç‰Œ
        state.players.forEach(p => p.seen = true);
        
        broadcastState({ type: 'win', pid: winnerPid }); // æ’­æ”¾èµ¢å®¶åŠ¨ç”»
        setTimeout(() => { toast(`ç©å®¶${winnerPid+1} èµ¢èµ°äº† ${state.pot} ç­¹ç ï¼`); }, 500);
        // 5ç§’åå‡†å¤‡ä¸‹ä¸€å±€
        setTimeout(() => { 
            state.players.forEach(p => p.status = p.chips > 0 ? 'ready' : 'lost');
            state.pot = 0;
            broadcastState();
            if(isHost) setTimeout(dealNewGame, 1000);
        }, 5000);
    }

    function broadcastState(anim = null) {
        const data = { t:'STATE', pl:state, anim: anim };
        hostConns.forEach(c => c.send(data)); // å‘ç»™å®¢äºº
        // æˆ¿ä¸»è‡ªå·±ä¹Ÿè¦å¤„ç†åŠ¨ç”»
        if(anim) playAnimation(anim);
        renderUI(); // æˆ¿ä¸»è‡ªå·±æ¸²æŸ“
    }

    // --- å®¢æˆ·ç«¯äº¤äº’ ---

    function doAct(act, val=0) {
        if(isHost) processAction(myPid, act, val);
        else myConn.send({t:'ACT', act:act, val:val});
        if(act === 'raise') toggleRaisePanel(); // å…³é—­é¢æ¿
    }

    function toggleRaisePanel() {
        const panel = document.getElementById('raise-panel');
        const baseSpan = document.getElementById('raise-base');
        const p = state.players[myPid];
        // è®¡ç®—å½“å‰çš„è·Ÿæ³¨æˆæœ¬ï¼Œä½œä¸ºåŠ æ³¨çš„åŸºç¡€å‚è€ƒ
        baseSpan.innerText = state.base * (p.seen ? 2 : 1);
        panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    }

    // --- æ ¸å¿ƒï¼šæ¸²æŸ“ä¸åŠ¨ç”» ---

    // æ’­æ”¾äº¤äº’åŠ¨ç”» (æ‰‹æ¨ç­¹ç )
    function playAnimation(anim) {
        if(anim.type === 'bet') {
            // è®¡ç®—èµ·ç‚¹ï¼šå½“å‰è¡ŒåŠ¨ç©å®¶çš„ä½ç½®
            const seatId = getSeatId(anim.pid);
            const seatElem = document.getElementById(`seat-${seatId}`);
            const rect = seatElem.getBoundingClientRect();
            const startX = rect.left + rect.width / 2;
            const startY = rect.top + rect.height / 2;
            
            // è®¡ç®—ç»ˆç‚¹ï¼šåº•æ± ä¸­å¿ƒ
            const potElem = document.getElementById('pot-area');
            const potRect = potElem.getBoundingClientRect();
            const endX = potRect.left + potRect.width / 2;
            const endY = potRect.top + potRect.height / 2;

            // è®¾ç½® CSS å˜é‡å¹¶è§¦å‘åŠ¨ç”»
            const hand = document.getElementById('virtual-hand');
            hand.style.setProperty('--start-x', `${startX - 50}px`); // 50æ˜¯æ‰‹å®½åº¦çš„ä¸€åŠï¼Œå±…ä¸­
            hand.style.setProperty('--start-y', `${startY - 60}px`);
            hand.style.setProperty('--end-x', `${endX - 50}px`);
            hand.style.setProperty('--end-y', `${endY - 60}px`);
            
            // é‡ç½®åŠ¨ç”»
            hand.style.animation = 'none';
            hand.offsetHeight; /* trigger reflow */
            hand.style.animation = 'push-chips 1.2s forwards ease-in-out';

            // å¯ä»¥é…åˆéŸ³æ•ˆ (æš‚çœç•¥)
            // playSound('chip_move');
        }
    }

    // æ¸²æŸ“ç•Œé¢UI
    function renderUI() {
        // 1. å…¬å…±ä¿¡æ¯
        document.getElementById('pot-val').innerText = state.pot;
        document.getElementById('base-val').innerText = state.base;
        
        // æ¸²æŸ“åº•æ± ç­¹ç å † (ç®€å•æ¨¡æ‹Ÿï¼Œç”¨å‡ ä¸ªå¤§é¢ç­¹ç è¡¨ç¤º)
        const potChips = document.getElementById('pot-chips');
        potChips.innerHTML = '';
        if(state.pot > 0) {
            // ç®€å•ç®—æ³•ï¼šæ¯100åŠ ä¸€ä¸ªçº¢ç­¹ç ï¼Œæ¯50åŠ ä¸€ä¸ªç»¿çš„...
            let tempPot = state.pot;
            const count100 = Math.floor(tempPot / 100); tempPot %= 100;
            const count50 = Math.floor(tempPot / 50); tempPot %= 50;
            const count10 = Math.floor(tempPot / 10);
            // å †å æ˜¾ç¤ºï¼Œç¨å¾®é”™å¼€ä¸€ç‚¹ä½ç½®
            for(let i=0; i<count100; i++) potChips.innerHTML += `<div class="chip chip-100" style="top:${i*2}px; left:${i*5}px">100</div>`;
            for(let i=0; i<count50; i++) potChips.innerHTML += `<div class="chip chip-50" style="top:${i*2+5}px; left:${i*5+30}px">50</div>`;
            for(let i=0; i<count10; i++) potChips.innerHTML += `<div class="chip chip-10" style="top:${i*2+10}px; left:${i*5+60}px">10</div>`;
        }

        // 2. æ¸²æŸ“å››ä½ç©å®¶
        for(let i=0; i<4; i++) {
            const pid = (myPid + i) % 4; // å®é™…ç©å®¶ID
            const seatId = i; // ç›¸å¯¹åº§ä½ID (0=è‡ªå·±, 1=å·¦, 2=ä¸Š, 3=å³)
            const p = state.players[pid];
            const seatElem = document.getElementById(`seat-${seatId}`);

            // æ›´æ–°ä¿¡æ¯
            document.getElementById(`chips-${seatId}`).innerText = p.chips;
            document.getElementById(`status-${seatId}`).innerText = p.folded?'å¼ƒç‰Œ':(p.seen?'å·²çœ‹':'é—·ç‰Œ');
            // é«˜äº®å½“å‰è¡ŒåŠ¨ç©å®¶
            seatElem.querySelector('.player-info').classList.toggle('active', state.turn === pid && state.phase === 'playing');
            // åº„å®¶æ ‡è®° (ç®€å•åŠ ä¸ªæ˜Ÿå·)
            seatElem.querySelector('.player-name').innerText = `ç©å®¶ ${pid+1} ${state.dealer===pid?'â­':''}`;

            // æ¸²æŸ“ç‰Œ
            const cardsDiv = document.getElementById(`cards-${seatId}`);
            cardsDiv.innerHTML = '';
            // åªæœ‰è‡ªå·±æˆ–è€…æ‘Šç‰Œé˜¶æ®µæ‰æ˜¾ç¤ºç‰Œé¢
            const show = (pid === myPid && p.seen) || state.phase === 'showdown';
            p.hand.forEach(c => {
                const card = document.createElement('div');
                card.className = p.folded ? 'card back folded' : (show ? `card ${['â™¥','â™¦'].includes(c.s)?'red':''}` : 'card back');
                if(show && !p.folded) card.innerHTML = `${c.s}<br>${c.r}`;
                cardsDiv.appendChild(card);
            });

            // æ¸²æŸ“èº«å‰ç­¹ç å † (ä»…è‡ªå·±ï¼Œä½œä¸ºç¤ºä¾‹)
            if(seatId === 0) {
                const myPile = document.getElementById('my-pile');
                myPile.innerHTML = '';
                // ç®€å•å±•ç¤ºå‡ ä¸ªç­¹ç ä»£è¡¨èº«å®¶
                if(p.chips >= 100) myPile.innerHTML += '<div class="chip-stack"><div class="chip chip-100">100</div></div>';
                if(p.chips >= 50) myPile.innerHTML += '<div class="chip-stack"><div class="chip chip-50">50</div></div>';
                if(p.chips >= 10) myPile.innerHTML += '<div class="chip-stack"><div class="chip chip-10">10</div></div>';
            }
        }

        // 3. åº•éƒ¨æŒ‰é’®çŠ¶æ€
        const myP = state.players[myPid];
        const canAct = state.phase === 'playing' && state.turn === myPid && !myP.folded;
        const currentCost = state.base * (myP.seen ? 2 : 1);
        
        document.getElementById('tag-call').innerText = currentCost;
        document.getElementById('btn-fold').disabled = !canAct;
        document.getElementById('btn-look').disabled = !canAct || myP.seen;
        document.getElementById('btn-call').disabled = !canAct || myP.chips < currentCost;
        document.getElementById('btn-raise').disabled = !canAct || myP.chips < currentCost + 10; // è‡³å°‘èƒ½åŠ 10
    }

    // åˆæ¬¡åŠ è½½ï¼Œæ¸²æŸ“ç©ºçŠ¶æ€
    renderUI();

</script>
</body>
</html>
