<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš‡å®¶èµŒåœº - æ²‰æµ¸ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- 1. åŸºç¡€ç¯å¢ƒ --- */
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; height: 100vh; width: 100vw; user-select: none; -webkit-touch-callout: none;}
        
        /* çœŸå®æ¡Œé¢æè´¨ */
        #table {
            position: relative; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #0e5c2f 0%, #032b14 90%);
            box-shadow: inset 0 0 150px #000;
            display: flex; justify-content: center; align-items: center;
        }
        /* æ¡Œå¸ƒçº¹ç† */
        #table::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/felt.png'); /* æ¯¡å¸ƒçº¹ç† */
            opacity: 0.3; pointer-events: none;
        }
        
        /* --- 2. å®ä½“ç»„ä»¶ï¼šç‰Œä¸ç­¹ç  --- */
        
        /* æ‰‘å…‹ç‰Œå®¹å™¨ (ç”¨äºç¿»è½¬åŠ¨ç”») */
        .card-wrapper {
            width: 50px; height: 75px; position: absolute;
            transform-style: preserve-3d; transition: transform 0.6s, top 0.5s, left 0.5s;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5); border-radius: 6px;
        }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 6px; display: flex; justify-content: center; align-items: center;
            font-size: 24px; font-weight: bold; background: #fff; border: 1px solid #ccc;
        }
        .card-back {
            background: #b71c1c; 
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.2) 0, rgba(255,255,255,0.2) 2px, transparent 2px, transparent 4px);
            border: 2px solid #fff;
            transform: rotateY(180deg); /* åˆå§‹èƒŒé¢æœä¸Š */
        }
        .card-front { transform: rotateY(0deg); color: #000; }
        .card-front.red { color: #d32f2f; }
        
        /* ç­¹ç æ ·å¼ (æ‹Ÿç‰©åŒ–) */
        .chip {
            width: 44px; height: 44px; border-radius: 50%; 
            border: 5px dashed rgba(255,255,255,0.4); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.6), inset 0 2px 5px rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 14px; font-weight: 900; color: #fff; text-shadow: 0 1px 2px #000;
            cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .chip:active { transform: scale(0.9); }
        .chip-5 { background: #c0392b; border-color: #e74c3c; } /* çº¢ */
        .chip-10 { background: #2980b9; border-color: #3498db; } /* è“ */
        .chip-20 { background: #27ae60; border-color: #2ecc71; } /* ç»¿ */
        .chip-50 { background: #8e44ad; border-color: #9b59b6; } /* ç´« */
        .chip-100 { background: #f39c12; border-color: #f1c40f; color: #000; text-shadow:none;} /* é»‘/é‡‘ */

        /* ç‰Œå † (Deck) */
        #deck-pile {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 75px; background: #b71c1c;
            border-radius: 6px; box-shadow: 0 0 0 2px #fff, 0 5px 15px rgba(0,0,0,0.5);
        }

        /* --- 3. å¸ƒå±€åŒºåŸŸ --- */
        
        /* åº•æ±  */
        #pot-area {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            width: 150px; height: 100px; border: 2px solid rgba(255,215,0,0.3); border-radius: 50px;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.2);
        }
        .pot-text { position: absolute; top: -30px; color: #f1c40f; font-weight: bold; text-shadow: 0 2px 4px #000;}

        /* åº§ä½å¸ƒå±€ */
        .seat { position: absolute; width: 120px; height: 120px; transition: opacity 0.5s; z-index: 10;}
        /* 2äººå±€åªç”¨ top/bottom, 4äººå±€ç”¨å…¨å¥— */
        .seat-bottom { bottom: 140px; left: 50%; transform: translateX(-50%); } /* è‡ªå·± */
        .seat-top { top: 60px; left: 50%; transform: translateX(-50%); }    /* å¯¹æ‰‹ */
        .seat-left { top: 50%; left: 20px; transform: translateY(-50%); }
        .seat-right { top: 50%; right: 20px; transform: translateY(-50%); }

        .player-info { text-align: center; color: white; text-shadow: 0 2px 5px black; }
        .player-status { font-size: 12px; background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 10px; display: inline-block; margin-bottom: 5px;}
        
        /* ç©å®¶çš„æ‰‹ç‰ŒåŒº */
        .hand-zone { position: absolute; width: 160px; height: 80px; top: 0; left: 50%; transform: translateX(-50%); pointer-events: none;}
        
        /* ç©å®¶çš„ç­¹ç åŒº (å±•ç¤ºç”¨) */
        .chip-display { 
            display: flex; gap: 5px; justify-content: center; margin-top: 80px; 
            transform: scale(0.6); opacity: 0.8;
        }

        /* --- 4. æ§åˆ¶é¢æ¿ (Dashboard) --- */
        #dashboard {
            position: absolute; bottom: 0; width: 100%; height: 120px;
            background: linear-gradient(to top, #111, rgba(0,0,0,0));
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 20px; z-index: 100;
        }
        
        /* ç­¹ç é€‰æ‹©æ  */
        #chip-selector { 
            display: flex; gap: 15px; margin-bottom: 15px; 
            background: rgba(0,0,0,0.5); padding: 10px 30px; border-radius: 40px; border: 1px solid #444;
            transition: transform 0.3s;
        }
        #chip-selector.disabled { filter: grayscale(1); pointer-events: none; opacity: 0.5; }

        /* æŒ‰é’®æ  */
        .btn-group { display: flex; gap: 10px; }
        .btn { 
            padding: 10px 25px; border-radius: 5px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; color: white; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.5); transition: 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:disabled { background: #555 !important; color: #aaa; cursor: not-allowed; transform: none; box-shadow: none;}
        .btn-fold { background: #c0392b; }
        .btn-look { background: #f39c12; color: #000; }
        .btn-comp { background: #8e44ad; }

        /* --- 5. åŠ¨ç”»å±‚ --- */
        #anim-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        
        /* è™šæ‹Ÿæ‰‹ */
        .virtual-hand {
            position: absolute; width: 80px; height: 80px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M21 12l-4.5 4.5 1.4 1.4 3.1-3.1V24h-2v-8h-2v8h-2v-8h-2v8H9v-8H7v8H5V11.5L8.5 8 12 4.5 13.4 5.9 9.9 9.4 12 11.5l1.4-1.4 4.2-4.2 1.4 1.4L15.3 11 21 12z"/></svg>');
            background-repeat: no-repeat; opacity: 0;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }

        /* å¤§å…å¼¹çª— */
        #lobby-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: #fff;
        }
        input { padding: 12px; font-size: 16px; border-radius: 5px; border: none; text-align: center; margin: 10px;}

        /* æç¤º */
        #toast {
            position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #f1c40f; padding: 10px 30px;
            border: 2px solid #f1c40f; border-radius: 30px; display: none; z-index: 3000; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="lobby-modal">
    <h1 style="color:#f1c40f; margin-bottom: 5px;">ğŸ›ï¸ çš‡å®¶èµŒåœº</h1>
    <p style="color:#aaa; font-size: 12px; margin-bottom: 30px;">æ²‰æµ¸å¼ 2-4 äººå¯¹æˆ˜</p>
    
    <div id="lobby-btns">
        <button class="btn" style="background:#2980b9; width: 200px;" onclick="initHost()">åˆ›å»ºæˆ¿é—´ (æˆ¿ä¸»)</button>
        <div style="margin: 15px; color:#555">- OR -</div>
        <input type="text" id="join-id" placeholder="è¾“å…¥æˆ¿ä¸»ID">
        <button class="btn" style="background:#27ae60; width: 200px;" onclick="initGuest()">åŠ å…¥æˆ¿é—´</button>
    </div>
    
    <div id="lobby-wait" style="display:none; text-align:center;">
        <p>ä½ çš„æˆ¿é—´ ID (ç‚¹å‡»å¤åˆ¶):</p>
        <input type="text" id="my-id-disp" readonly onclick="copyId()" style="background:#fff; color:#000; font-weight:bold; width: 250px;">
        <div id="player-list" style="margin-top:20px; color: #ccc;">ç­‰å¾…ç©å®¶...</div>
        <button id="btn-start" class="btn" style="background:#f39c12; color:#000; margin-top:20px;" disabled onclick="startGame()">å¼€å§‹å‘ç‰Œ</button>
    </div>
</div>

<div id="table">
    <div id="deck-pile"></div>

    <div id="pot-area">
        <div class="pot-text">POT: <span id="pot-val">0</span></div>
        </div>
    
    <div id="seats-container"></div>
    
    <div id="anim-layer"></div>

    <div id="dashboard">
        <div id="chip-selector" class="disabled">
            <div class="chip chip-5" onclick="userBet(5)">5</div>
            <div class="chip chip-10" onclick="userBet(10)">10</div>
            <div class="chip chip-20" onclick="userBet(20)">20</div>
            <div class="chip chip-50" onclick="userBet(50)">50</div>
            <div class="chip chip-100" onclick="userBet(100)">100</div>
        </div>

        <div class="btn-group">
            <button id="btn-fold" class="btn btn-fold" disabled onclick="userAct('fold')">å¼ƒç‰Œ</button>
            <button id="btn-look" class="btn btn-look" disabled onclick="userAct('look')">çœ‹ç‰Œ</button>
            <button id="btn-comp" class="btn btn-comp" disabled onclick="userAct('comp')">æ¯”ç‰Œ (åŒå€)</button>
        </div>
    </div>
</div>

<div id="toast">æç¤ºä¿¡æ¯</div>

<script>
    // --- é…ç½® ---
    const PEER_CONF = { config: { 'iceServers': [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.qq.com:3478' } ] } };
    
    // --- çŠ¶æ€å˜é‡ ---
    let peer, conn, conns = []; 
    let myPid = -1, isHost = false, playerCount = 1;
    let state = {
        phase: 'lobby', pot: 0, currentBet: 0, turn: 0, dealer: 0,
        players: [] 
    };
    // åˆå§‹ç­¹ç ç»“æ„: 5ç§é¢é¢ï¼Œæ¯ç§10ä¸ª (è™½ç„¶é€»è¾‘ä¸Šç”¨æ€»é¢ï¼Œä½†ä¸ºäº†è§†è§‰æ•ˆæœæˆ‘ä»¬å‡è£…æœ‰è¿™äº›)
    const INIT_CHIPS = 5*10 + 10*10 + 20*10 + 50*10 + 100*10; // 1850

    // --- å·¥å…· ---
    const $ = id => document.getElementById(id);
    const toast = m => { $('toast').innerText=m; $('toast').style.display='block'; setTimeout(()=>$('toast').style.display='none',2000); }
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    // --- ç½‘ç»œé€»è¾‘ ---
    function initHost() {
        isHost = true; myPid = 0;
        $('lobby-btns').style.display='none'; $('lobby-wait').style.display='block';
        updateLobbyList();
        
        peer = new Peer(null, PEER_CONF);
        peer.on('open', id => $('my-id-disp').value = id);
        peer.on('connection', c => {
            if(state.phase !== 'lobby') { c.close(); return; }
            conns.push(c);
            c.on('open', () => {
                c.send({t:'WELCOME', pid: conns.length}); // åˆ†é…PID
                playerCount++;
                updateLobbyList();
                if(playerCount >= 2) $('btn-start').disabled = false;
            });
            c.on('data', d => handleDataHost(d, conns.indexOf(c) + 1));
            c.on('close', () => location.reload());
        });
    }

    function initGuest() {
        const dest = $('join-id').value.trim();
        if(!dest) return toast("è¯·è¾“å…¥ID");
        peer = new Peer(null, PEER_CONF);
        peer.on('open', () => {
            conn = peer.connect(dest);
            conn.on('data', handleDataGuest);
            conn.on('close', () => alert("è¿æ¥æ–­å¼€"));
        });
    }

    function updateLobbyList() {
        $('player-list').innerHTML = `å½“å‰ç©å®¶æ•°: ${playerCount}<br>(æœ€å°‘2äººï¼Œæœ€å¤š4äºº)`;
    }

    // --- æ•°æ®å¤„ç† ---
    function handleDataGuest(d) {
        if(d.t === 'WELCOME') {
            myPid = d.pid;
            playerCount = d.pCount; // æš‚æ—¶ä¸çŸ¥æ€»äººæ•°ï¼Œç­‰å¾… Start
            toast("å·²åŠ å…¥ï¼Œç­‰å¾…æˆ¿ä¸»...");
            $('lobby-btns').innerHTML = "<h3 style='color:#2ecc71'>å·²è¿æ¥ï¼ç­‰å¾…å‘ç‰Œ...</h3>";
        }
        if(d.t === 'SYNC') {
            // åŒæ­¥å…¨éƒ¨çŠ¶æ€
            state = d.state;
            playerCount = state.players.length;
            if($('lobby-modal').style.display !== 'none') {
                $('lobby-modal').style.display = 'none'; // å…³é—­å¤§å…
                renderSeats(); // åˆå§‹åŒ–åº§ä½
            }
            renderUI();
        }
        if(d.t === 'ANIM_DEAL') playDealAnim(d.toPid, d.cardIdx);
        if(d.t === 'ANIM_CHIP') playChipAnim(d.pid, d.val);
    }

    function handleDataHost(d, fromPid) {
        if(d.t === 'ACT') processAction(fromPid, d.act, d.val);
    }

    function broadcast(msg) {
        conns.forEach(c => c.send(msg));
    }

    // --- æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (Host Only) ---
    async function startGame() {
        // åˆå§‹åŒ–ç©å®¶æ•°æ®
        for(let i=0; i<playerCount; i++) {
            state.players[i] = { 
                chips: INIT_CHIPS, hand: [], status: 'play', 
                seen: false, folded: false, betRound: 0 
            };
        }
        state.phase = 'game';
        broadcast({t:'SYNC', state: state}); // è®©æ‰€æœ‰å®¢æˆ·ç«¯å…³é—­å¤§å…
        renderSeats();
        startNewRound();
    }

    async function startNewRound() {
        // æ´—ç‰Œ
        const suits = ['â™ ','â™¥','â™£','â™¦'];
        const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        let deck = [];
        suits.forEach(s => ranks.forEach(r => deck.push({s,r})));
        deck.sort(() => Math.random() - 0.5);

        // é‡ç½®å±€æ•°æ®
        state.pot = 0; state.currentBet = 0; // è¿™é‡Œçš„currentBetæ˜¯å•æ³¨é¢
        state.dealer = (state.dealer + 1) % playerCount;
        state.turn = (state.dealer + 1) % playerCount;
        
        state.players.forEach(p => {
            if(p.chips > 0) {
                p.status = 'play'; p.hand = [deck.pop(), deck.pop(), deck.pop()];
                p.seen = false; p.folded = false; p.betRound = 0;
            } else p.status = 'lost';
        });

        broadcast({t:'SYNC', state: state});
        
        // --- æ’­æ”¾å‘ç‰ŒåŠ¨ç”» ---
        // æ¯ä¸ªäººå‘3å¼ ï¼Œä¸€å¼ ä¸€å¼ å‘
        for(let c=0; c<3; c++) {
            for(let p=0; p<playerCount; p++) {
                const pid = (state.dealer + 1 + p) % playerCount; // ä»åº„å®¶ä¸‹å®¶å¼€å§‹å‘
                if(state.players[pid].status === 'play') {
                    // å‘é€åŠ¨ç”»æŒ‡ä»¤
                    const msg = {t:'ANIM_DEAL', toPid: pid, cardIdx: c};
                    broadcast(msg); 
                    playDealAnim(pid, c); // æˆ¿ä¸»è‡ªå·±æ’­
                    await sleep(200); // é—´éš”
                }
            }
        }
        
        toast("å¼€å§‹ä¸‹æ³¨ï¼");
    }

    function processAction(pid, act, val) {
        if(state.turn !== pid) return;
        const p = state.players[pid];
        
        if(act === 'fold') {
            p.folded = true; p.status = 'fold';
        } else if (act === 'look') {
            p.seen = true; // ä¸æ¢å›åˆ
            broadcast({t:'SYNC', state: state});
            return;
        } else if (act === 'bet') {
            // val æ˜¯ç­¹ç é¢é¢ (5, 10 ç­‰)
            // æ‰£è´¹é€»è¾‘
            if(p.chips >= val) {
                p.chips -= val;
                p.betRound += val;
                state.pot += val;
                // åŠ¨ç”»
                const msg = {t:'ANIM_CHIP', pid: pid, val: val};
                broadcast(msg); playChipAnim(pid, val);
                
                // ç®€å•çš„åˆ‡å›åˆé€»è¾‘ï¼šåªè¦åŠ¨äº†ç­¹ç å°±æ¢äºº (ç®€åŒ–ç‰ˆè§„åˆ™)
                // å®é™…è§„åˆ™å¯èƒ½éœ€è¦å¹³æ³¨ï¼Œä½†ä¸ºäº†æ¼”ç¤ºæµç•…æ€§ï¼Œè¿™é‡Œè®¾ä¸ºæ¯æ¬¡æ“ä½œåæ¢äºº
            }
        } else if (act === 'comp') {
            // æ¯”ç‰Œé€»è¾‘ç®€åŒ–ï¼šæ‰£å¤§é¢ï¼Œç„¶ååˆ¤å®šè¾“èµ¢
            const cost = 100; // å‡è®¾æ¯”ç‰Œå›ºå®š100
            if(p.chips >= cost) {
                p.chips -= cost; state.pot += cost;
                // ç®€å•åˆ¤å®šï¼šç›´æ¥ç»“æŸæœ¬å±€ï¼Œéšæœºèµ¢å®¶ï¼ˆæ¼”ç¤ºç”¨ï¼‰æˆ–æ¯”è¾ƒå¤§å°
                // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ç›´æ¥è®©æ¯”ç‰Œå‘èµ·è€…èµ¢ (å·æ‡’ï¼Œä¸ºäº†ä»£ç é•¿åº¦)
                endRound(pid);
                return; 
            }
        }

        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªå¼ƒç‰Œçš„ç©å®¶
        let loops = 0;
        do {
            state.turn = (state.turn + 1) % playerCount;
            loops++;
        } while((state.players[state.turn].status !== 'play') && loops < playerCount);

        // å¦‚æœåªå‰©ä¸€äºº
        const active = state.players.filter(p => p.status === 'play');
        if(active.length === 1) {
            endRound(state.players.indexOf(active[0]));
        } else {
            broadcast({t:'SYNC', state: state});
        }
    }

    function endRound(winnerPid) {
        state.players[winnerPid].chips += state.pot;
        // å¼ºåˆ¶å…¨å‘˜çœ‹ç‰Œ
        state.players.forEach(p => p.seen = true);
        broadcast({t:'SYNC', state: state});
        toast(`ç©å®¶ ${winnerPid+1} è·èƒœï¼èµ¢å– ${state.pot}`);
        setTimeout(() => {
            if(isHost) startNewRound();
        }, 4000);
    }

    // --- å®¢æˆ·ç«¯äº¤äº’ ---
    function userBet(val) {
        const p = state.players[myPid];
        // æ£€æŸ¥ï¼šæ˜¯å¦è½®åˆ°æˆ‘ï¼Œé’±å¤Ÿä¸å¤Ÿ
        if(state.turn !== myPid || p.chips < val) return;
        
        // å‘é€åŠ¨ä½œ
        if(isHost) processAction(myPid, 'bet', val);
        else conn.send({t:'ACT', act:'bet', val: val});
    }

    function userAct(act) {
        if(state.turn !== myPid) return;
        if(isHost) processAction(myPid, act);
        else conn.send({t:'ACT', act: act});
    }

    // --- æ¸²æŸ“ä¸åŠ¨ç”» (æ ¸å¿ƒè§†è§‰) ---

    // 1. åŠ¨æ€ç”Ÿæˆåº§ä½
    function renderSeats() {
        const container = $('seats-container');
        container.innerHTML = '';
        
        // 2äººå±€: Top/Bottom. 3-4äººå±€: åå­—å¸ƒå±€
        for(let i=0; i<playerCount; i++) {
            // è®¡ç®—ç›¸å¯¹ä½ç½®ï¼šä»¥è‡ªå·±(myPid)ä¸ºåŸºå‡†ï¼Œé€†æ—¶é’ˆæ—‹è½¬
            // æ¯”å¦‚æˆ‘æ˜¯0: 0->Bottom, 1->Left... 
            // å¦‚æœæ˜¯2äºº: 0->Bottom, 1->Top
            let posClass = '';
            const relIdx = (i - myPid + playerCount) % playerCount;
            
            if(playerCount === 2) {
                posClass = relIdx === 0 ? 'seat-bottom' : 'seat-top';
            } else {
                if(relIdx === 0) posClass = 'seat-bottom';
                else if(relIdx === 1) posClass = 'seat-right'; // é€†æ—¶é’ˆ
                else if(relIdx === 2) posClass = 'seat-top';
                else posClass = 'seat-left';
            }

            const div = document.createElement('div');
            div.className = `seat ${posClass}`;
            div.id = `seat-${i}`;
            div.innerHTML = `
                <div class="hand-zone" id="hand-${i}"></div>
                <div class="player-info">
                    <div style="font-weight:bold">ç©å®¶ ${i+1}</div>
                    <div class="player-status" id="stat-${i}">å‡†å¤‡</div>
                    <div style="color:#f1c40f">ğŸ’° <span id="chips-${i}">${INIT_CHIPS}</span></div>
                </div>
                <div class="chip-display">
                    <div class="chip chip-10" style="width:20px;height:20px;border-width:2px;font-size:0;"></div>
                    <div class="chip chip-50" style="width:20px;height:20px;border-width:2px;font-size:0;"></div>
                    <div class="chip chip-100" style="width:20px;height:20px;border-width:2px;font-size:0;"></div>
                </div>
            `;
            container.appendChild(div);
        }
    }

    // 2. æ›´æ–°UIæ•°æ®
    function renderUI() {
        $('pot-val').innerText = state.pot;
        
        state.players.forEach((p, i) => {
            $(`chips-${i}`).innerText = p.chips;
            const statText = p.folded ? "å¼ƒç‰Œ" : (i === state.turn ? "æ€è€ƒä¸­..." : "ç­‰å¾…");
            $(`stat-${i}`).innerText = statText;
            $(`stat-${i}`).style.background = (i === state.turn) ? "#e67e22" : "rgba(0,0,0,0.6)";
            
            // æ¸²æŸ“æ‰‹ç‰Œ (å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™åªæ›´æ–°ç¿»è½¬çŠ¶æ€)
            const zone = $(`hand-${i}`);
            // å¦‚æœåŒºåŸŸé‡Œæ²¡æœ‰ç‰Œå…ƒç´ ï¼Œè¯´æ˜è¿˜æ²¡å‘ç‰Œï¼Œä¸åœ¨è¿™é‡Œæ¸²æŸ“ï¼Œç”±åŠ¨ç”»å‡½æ•°è´Ÿè´£åˆ›å»º
            // è¿™é‡Œä¸»è¦è´Ÿè´£ç¿»é¢é€»è¾‘
            if(zone.children.length === 3) {
                const shouldShow = (i === myPid && p.seen) || p.seen; // è¿™é‡Œçš„ p.seen åœ¨ç»“æŸæ—¶ä¼šè¢«å¼ºåˆ¶ç½®true
                Array.from(zone.children).forEach((wrapper, idx) => {
                    const cardData = p.hand[idx];
                    const face = wrapper.querySelector('.card-front');
                    if(shouldShow && !p.folded) {
                        wrapper.querySelector('.card-back').style.transform = "rotateY(0deg)"; // èƒŒé¢éš
                        face.style.transform = "rotateY(0deg)"; // æ­£é¢æ˜¾
                        face.className = `card-face card-front ${['â™¥','â™¦'].includes(cardData.s)?'red':''}`;
                        face.innerText = cardData.s + cardData.r;
                    } else {
                         // ä¿æŒèƒŒé¢
                    }
                });
            }
        });

        // æŒ‰é’®çŠ¶æ€
        const me = state.players[myPid];
        const isMyTurn = state.turn === myPid && me.status === 'play';
        $('chip-selector').className = isMyTurn ? '' : 'disabled';
        $('btn-fold').disabled = !isMyTurn;
        $('btn-look').disabled = !isMyTurn || me.seen;
        $('btn-comp').disabled = !isMyTurn || me.chips < 100;
    }

    // 3. å‘ç‰ŒåŠ¨ç”» (æ ¸å¿ƒ)
    function playDealAnim(targetPid, cardIndex) {
        // åˆ›å»ºä¸€å¼ ä¸´æ—¶ç‰Œåœ¨ Deck ä½ç½®
        const deckRect = $('deck-pile').getBoundingClientRect();
        const wrapper = document.createElement('div');
        wrapper.className = 'card-wrapper';
        wrapper.innerHTML = `
            <div class="card-face card-front"></div>
            <div class="card-face card-back" style="transform: rotateY(0deg);"></div> 
        `; // åˆå§‹åªæœ‰èƒŒé¢
        
        // åˆå§‹ä½ç½®ï¼šå±å¹•ä¸­å¿ƒ (Deck)
        wrapper.style.left = deckRect.left + 'px';
        wrapper.style.top = deckRect.top + 'px';
        $('anim-layer').appendChild(wrapper);

        // è®¡ç®—ç›®æ ‡ä½ç½®
        const targetZone = $(`hand-${targetPid}`);
        const targetRect = targetZone.getBoundingClientRect();
        // ç‰Œåœ¨æ‰‹é‡Œæ˜¯å±•å¼€çš„ï¼Œè®¡ç®—åç§»
        const offsetX = (targetRect.width / 2) - 25 + (cardIndex - 1) * 20; 
        
        // å¼ºåˆ¶é‡ç»˜
        wrapper.offsetHeight; 

        // é£è¡ŒåŠ¨ç”»
        wrapper.style.left = (targetRect.left + offsetX) + 'px';
        wrapper.style.top = (targetRect.top + 10) + 'px';
        // ç¨å¾®æ—‹è½¬ä¸€ç‚¹å¢åŠ çœŸå®æ„Ÿ
        const rot = (cardIndex - 1) * 5;
        wrapper.style.transform = `rotate(${rot}deg)`;

        // åŠ¨ç”»ç»“æŸåï¼ŒæŠŠè¿™ä¸ªDOMä»åŠ¨ç”»å±‚ç§»åˆ°ç©å®¶çš„å®é™…Handå±‚ï¼Œå˜æˆé™æ€æ˜¾ç¤º
        setTimeout(() => {
            wrapper.style.position = 'absolute';
            wrapper.style.left = (50 + (cardIndex - 1) * 30) + 'px'; // ç›¸å¯¹åæ ‡
            wrapper.style.top = '0px';
            wrapper.style.transform = `rotate(${rot}deg)`; // ä¿æŒæ—‹è½¬
            // ä¿®æ­£èƒŒé¢çš„æ—‹è½¬é€»è¾‘ï¼Œå‡†å¤‡ç¿»ç‰Œ
            wrapper.querySelector('.card-back').style.transform = "rotateY(0deg)";
            wrapper.querySelector('.card-front').style.transform = "rotateY(180deg)";
            
            targetZone.appendChild(wrapper); // ç§»åŠ¨èŠ‚ç‚¹
        }, 500);
    }

    // 4. ç­¹ç é£å…¥åŠ¨ç”»
    function playChipAnim(pid, val) {
        // åˆ›å»ºç­¹ç 
        const chip = document.createElement('div');
        chip.className = `chip chip-${val}`;
        chip.innerText = val;
        chip.style.position = 'absolute';
        
        // èµ·ç‚¹ï¼šç©å®¶å¤´åƒä½ç½®
        const seat = $(`seat-${pid}`);
        const startRect = seat.getBoundingClientRect();
        chip.style.left = (startRect.left + 50) + 'px';
        chip.style.top = (startRect.top + 50) + 'px';
        
        $('anim-layer').appendChild(chip);
        
        // ç»ˆç‚¹ï¼šPot åŒºåŸŸçš„éšæœºä½ç½®
        const potRect = $('pot-area').getBoundingClientRect();
        const randX = Math.random() * 80;
        const randY = Math.random() * 40;
        
        // è§¦å‘åŠ¨ç”»
        requestAnimationFrame(() => {
            chip.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            chip.style.left = (potRect.left + 20 + randX) + 'px';
            chip.style.top = (potRect.top + 20 + randY) + 'px';
            chip.style.transform = `rotate(${Math.random()*360}deg)`;
        });

        // ä¹Ÿå¯ä»¥åŠ ä¸Šè™šæ‹Ÿæ‰‹åŠ¨ç”»
        showHandAnim(startRect.left + 50, startRect.top + 50);
    }

    function showHandAnim(x, y) {
        const hand = document.createElement('div');
        hand.className = 'virtual-hand';
        hand.style.left = (x - 20) + 'px'; // åç§»
        hand.style.top = (y + 20) + 'px';
        $('anim-layer').appendChild(hand);
        
        requestAnimationFrame(() => {
            hand.style.transition = 'opacity 0.2s, top 0.5s';
            hand.style.opacity = 1;
            hand.style.top = (y - 50) + 'px'; // å‘ä¸Šæ¨çš„åŠ¨ä½œ
            
            setTimeout(() => {
                hand.style.opacity = 0;
                setTimeout(() => hand.remove(), 500);
            }, 500);
        });
    }
    
    function copyId() { $('my-id-disp').select(); document.execCommand('copy'); toast("å·²å¤åˆ¶"); }

</script>
</body>
</html>
