<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ¨çº¿ç‚¸é‡‘èŠ± Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #1b262c; color: #ecf0f1; text-align: center; margin: 0; padding: 0; user-select: none; -webkit-touch-callout: none; overflow: hidden;}
        .container { max-width: 600px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        
        /* å¤§å…æ ·å¼ */
        #lobby { padding: 30px 20px; background: #2c3e50; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;}
        h1 { color:#f1c40f; margin-bottom: 5px; text-shadow: 2px 2px 0px #000; }
        input { padding: 15px; border-radius: 8px; border: none; width: 80%; text-align: center; font-size: 18px; margin: 15px 0; outline: none; background: #ecf0f1; color: #2c3e50; font-weight: bold;}
        .btn-main { background: #2980b9; color: white; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; font-size: 18px; width: 80%; font-weight: bold; margin: 10px 0; box-shadow: 0 5px 0 #1a5276; transition: 0.1s; }
        .btn-main:active { transform: translateY(5px); box-shadow: none; }
        .btn-green { background: #27ae60; box-shadow: 0 5px 0 #196f3d; }
        .btn-green:active { box-shadow: none; transform: translateY(5px); }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-area { display: none; background: #27ae60; flex: 1; position: relative; }
        
        .pot-box { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); padding: 10px 30px; border-radius: 30px; border: 3px solid #f1c40f; text-align: center; z-index: 5;}
        .pot-num { color: #f1c40f; font-size: 32px; font-weight: 800; }
        .msg-tip { position: absolute; top: 48%; width: 100%; text-align: center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-size: 14px; font-weight: bold;}

        /* ç©å®¶å¡ç‰‡åŒº */
        .player-zone { position: absolute; width: 100%; height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center;}
        .opponent { top: 20px; }
        .me { bottom: 100px; }

        .info-pill { background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-bottom: 8px; display: flex; gap: 10px; border: 1px solid rgba(255,255,255,0.3); }

        /* æ‰‘å…‹ç‰Œ */
        .cards-row { display: flex; justify-content: center; gap: 8px; }
        .card { width: 55px; height: 80px; background: white; border-radius: 6px; color: black; font-weight: bold; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); position: relative; border: 1px solid #bdc3c7; }
        .card.red { color: #c0392b; }
        .card.back { background: #34495e; border: 2px solid #ecf0f1; background-image: repeating-linear-gradient(45deg, #34495e 0, #34495e 5px, #2c3e50 5px, #2c3e50 10px); color: transparent; }

        /* æ“ä½œæ  */
        #action-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); padding: 15px 0; display: flex; justify-content: space-around; align-items: center; height: 70px; z-index: 100; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .btn-act { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 14px; font-weight: bold; position: relative; box-shadow: 0 4px 0 rgba(0,0,0,0.4); cursor: pointer; transition: 0.1s; display: flex; flex-direction: column; justify-content: center; align-items: center;}
        .btn-act:active { transform: translateY(4px); box-shadow: none; }
        .btn-act:disabled { filter: grayscale(1); opacity: 0.4; cursor: not-allowed; }
        
        .act-fold { background: #c0392b; }
        .act-look { background: #2980b9; }
        .act-call { background: #27ae60; }
        .act-raise { background: #e67e22; }
        .act-comp { background: #8e44ad; }
        
        .cost-tag { background: #f1c40f; color: black; font-size: 10px; padding: 1px 5px; border-radius: 4px; margin-top: 2px; }

        /* å¼¹çª—ä¸æ—¥å¿— */
        #log-window { position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: lime; font-size: 12px; padding: 5px; z-index: 999; display: none; text-align: left; }
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #fff; padding: 15px 30px; border-radius: 10px; z-index: 200; display: none; border: 1px solid #f1c40f; font-size: 18px;}
    </style>
</head>
<body>

<div id="log-window"></div>
<div id="toast">æç¤ºä¿¡æ¯</div>

<div class="container" id="lobby">
    <h1>â™ ï¸ ç‚¸é‡‘èŠ± Online</h1>
    <p style="color:#bdc3c7; font-size: 12px; margin-bottom: 20px;">Github Pages æé€Ÿç‰ˆ</p>
    
    <div id="panel-start" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <button class="btn-main" onclick="initHost()">æˆ‘æ˜¯æˆ¿ä¸» (åˆ›å»º)</button>
        <div style="height: 20px;"></div>
        <input type="text" id="dest-id" placeholder="ç²˜è´´æˆ¿ä¸»çš„ ID">
        <button class="btn-main btn-green" onclick="initGuest()">åŠ å…¥æˆ¿é—´</button>
    </div>

    <div id="panel-host" style="display:none; width: 100%; flex-direction: column; align-items: center;">
        <p style="color:#fff;">ä½ çš„æˆ¿é—´ ID (ç‚¹å‡»å¤åˆ¶):</p>
        <input type="text" id="my-id" readonly onclick="copyId()" style="font-family: monospace; letter-spacing: 1px;">
        <p id="host-status" style="color: #f1c40f;">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</p>
        <button class="btn-main" onclick="location.reload()" style="background:#7f8c8d; font-size: 14px; padding: 10px;">å–æ¶ˆ / åˆ·æ–°</button>
    </div>
</div>

<div class="container" id="game-area">
    <div class="pot-box">
        <div style="font-size: 10px; color:#fff; opacity: 0.8;">POOL</div>
        <div class="pot-num" id="pot">0</div>
        <div style="font-size: 10px; color:#f1c40f;">åº•æ³¨: <span id="base">10</span></div>
    </div>
    <div class="msg-tip" id="msg">ç­‰å¾…å¼€å§‹...</div>

    <div class="player-zone opponent">
        <div class="info-pill">
            <span id="opp-status">ç­‰å¾…ä¸­</span>
            <span>ğŸ’° <span id="opp-chips">1000</span></span>
        </div>
        <div class="cards-row" id="opp-cards">
            <div class="card back"></div><div class="card back"></div><div class="card back"></div>
        </div>
    </div>

    <button id="btn-restart" onclick="sendAction('ready')" style="position: absolute; bottom: 180px; left:50%; transform:translateX(-50%); z-index: 150; padding: 15px 40px; border-radius: 40px; border:none; background:#f1c40f; color:black; font-weight:bold; font-size:18px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none;">å‡†å¤‡ä¸‹ä¸€å±€</button>

    <div class="player-zone me">
        <div class="cards-row" id="my-cards">
            <div class="card back"></div><div class="card back"></div><div class="card back"></div>
        </div>
        <div class="info-pill" style="margin-top: 10px;">
            <span id="my-status" style="color:#f1c40f">å‡†å¤‡</span>
            <span>ğŸ’° <span id="my-chips">1000</span></span>
        </div>
    </div>

    <div id="action-bar">
        <button class="btn-act act-fold" id="btn-fold" onclick="sendAction('fold')">å¼ƒç‰Œ</button>
        <button class="btn-act act-look" id="btn-look" onclick="sendAction('look')">çœ‹ç‰Œ</button>
        <button class="btn-act act-call" id="btn-call" onclick="sendAction('call')">è·Ÿæ³¨<span class="cost-tag" id="val-call">10</span></button>
        <button class="btn-act act-raise" id="btn-raise" onclick="sendAction('raise')">åŠ æ³¨<span class="cost-tag" id="val-raise">20</span></button>
        <button class="btn-act act-comp" id="btn-comp" onclick="sendAction('comp')">æ¯”ç‰Œ<span class="cost-tag" id="val-comp">40</span></button>
    </div>
</div>

<script>
    // --- é…ç½®ä¸å˜é‡ ---
    const PEER_CONFIG = { config: { 'iceServers': [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' } ] } };
    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
    const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    const VALS = {'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
    
    let peer, conn, isHost = false, myRole = 'guest';
    let state = {
        pot: 0, base: 10, turn: '', over: true, winner: null,
        p: { host: {c:1000, h:[], s:false, f:false, r:false}, guest: {c:1000, h:[], s:false, f:false, r:false} }
    };

    // --- ç½‘ç»œé€»è¾‘ ---
    function log(m) { console.log(m); document.getElementById('log-window').innerHTML = m; }
    function toast(m) { 
        const t = document.getElementById('toast'); 
        t.innerText = m; t.style.display = 'block'; 
        setTimeout(()=>t.style.display='none', 2000); 
    }

    function initHost() {
        isHost = true; myRole = 'host';
        document.getElementById('panel-start').style.display = 'none';
        document.getElementById('panel-host').style.display = 'flex';
        
        peer = new Peer(null, PEER_CONFIG);
        peer.on('open', id => {
            document.getElementById('my-id').value = id;
            document.getElementById('host-status').innerText = "âœ… æœåŠ¡å·²å°±ç»ªï¼Œç­‰å¾…åŠ å…¥...";
        });
        peer.on('connection', c => {
            if(conn) { c.close(); return; }
            conn = c;
            bindConn();
        });
    }

    function initGuest() {
        isHost = false; myRole = 'guest';
        const dest = document.getElementById('dest-id').value.trim();
        if(!dest) return toast("è¯·è¾“å…¥æˆ¿ä¸»ID");
        
        toast("æ­£åœ¨è¿æ¥...");
        peer = new Peer(null, PEER_CONFIG);
        peer.on('open', () => {
            conn = peer.connect(dest, { reliable: true });
            bindConn();
        });
        peer.on('error', e => toast("è¿æ¥å¤±è´¥: " + e.type));
    }

    function bindConn() {
        conn.on('open', () => {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-area').style.display = 'flex';
            if(isHost) resetGame();
            else conn.send({t:'HELLO'}); // è§¦å‘åŒæ­¥
        });
        conn.on('data', d => {
            if(d.t === 'STATE') { state = d.pl; render(); }
            if(d.t === 'HELLO' && isHost) sync();
            if(d.t === 'ACT' && isHost) handleAct('guest', d.act);
        });
        conn.on('close', () => { alert("è¿æ¥æ–­å¼€"); location.reload(); });
    }

    function sync() { if(isHost && conn) conn.send({t:'STATE', pl: state}); render(); }

    // --- æ¸¸æˆé€»è¾‘ (Host) ---
    function resetGame() {
        if(!isHost) return;
        let deck = [];
        SUITS.forEach(s=>RANKS.forEach(r=>deck.push({s,r,v:VALS[r]})));
        deck.sort(()=>Math.random()-0.5);

        // æ£€æŸ¥ç ´äº§
        if(state.p.host.c < 10 || state.p.guest.c < 10) {
            state.over = true; state.winner = 'broken';
            sync(); return;
        }

        state.pot = 0; state.base = 10; state.over = false; state.winner = null;
        state.turn = Math.random()>0.5 ? 'host' : 'guest';
        
        ['host','guest'].forEach(r => {
            state.p[r].h = [deck.pop(), deck.pop(), deck.pop()];
            state.p[r].s = false; state.p[r].f = false; state.p[r].r = false;
            state.p[r].c -= 10; state.pot += 10;
        });
        sync();
    }

    function handleAct(role, act) {
        if(!isHost) return;
        const p = state.p[role];
        const opp = state.p[role==='host'?'guest':'host'];
        
        if(act === 'ready') {
            p.r = true;
            if(state.p.host.r && state.p.guest.r) resetGame();
            else sync();
            return;
        }

        if(state.over || state.turn !== role) return;

        let cost = 0;
        switch(act) {
            case 'look': p.s = true; break;
            case 'fold': p.f = true; endGame(role==='host'?'guest':'host'); return;
            case 'call': 
                cost = state.base * (p.s?2:1);
                if(p.c >= cost) { p.c-=cost; state.pot+=cost; state.turn = role==='host'?'guest':'host'; }
                break;
            case 'raise':
                state.base = Math.min(state.base*2, 200);
                cost = state.base * (p.s?2:1);
                if(p.c >= cost) { p.c-=cost; state.pot+=cost; state.turn = role==='host'?'guest':'host'; }
                else state.base /= 2;
                break;
            case 'comp':
                cost = state.base * (p.s?2:1) * 2;
                if(p.c >= cost) {
                    p.c-=cost; state.pot+=cost;
                    const r1 = score(p.h); const r2 = score(opp.h);
                    endGame(cmp(r1, r2) > 0 ? role : (role==='host'?'guest':'host'));
                    return;
                }
                break;
        }
        sync();
    }

    function endGame(winner) {
        state.over = true; state.winner = winner;
        if(winner !== 'broken') state.p[winner].c += state.pot;
        state.p.host.s = true; state.p.guest.s = true;
        sync();
    }

    // --- å®¢æˆ·ç«¯ ---
    function sendAction(act) {
        if(isHost) handleAct('host', act);
        else conn.send({t:'ACT', act: act});
    }

    function render() {
        const me = state.p[myRole];
        const opp = state.p[myRole==='host'?'guest':'host'];
        
        document.getElementById('pot').innerText = state.pot;
        document.getElementById('base').innerText = state.base;
        document.getElementById('my-chips').innerText = me.c;
        document.getElementById('opp-chips').innerText = opp.c;

        // çŠ¶æ€æ–‡å­—
        if(state.winner === 'broken') document.getElementById('msg').innerText = "æœ‰äººç ´äº§äº†ï¼Œè¯·åˆ·æ–°é‡æ¥";
        else if(state.over) document.getElementById('msg').innerText = state.winner === myRole ? "ğŸ‰ ä½ èµ¢äº†!" : "ğŸ˜­ ä½ è¾“äº†";
        else document.getElementById('msg').innerText = state.turn === myRole ? "ğŸ‘‰ è½®åˆ°ä½ äº†" : "â³ ç­‰å¾…å¯¹æ–¹...";
        
        document.getElementById('my-status').innerText = me.f?"å·²å¼ƒ":me.s?"å·²çœ‹":"é—·ç‰Œ";
        document.getElementById('opp-status').innerText = opp.f?"å·²å¼ƒ":opp.s?"å·²çœ‹":"é—·ç‰Œ";

        // ç‰Œé¢
        drawCards('my-cards', me.h, me.s || state.over);
        drawCards('opp-cards', opp.h, state.over); // å¯¹æ‰‹ç‰Œåªæœ‰ç»“æŸæ‰æ˜¾ç¤º

        // æŒ‰é’®äº¤äº’
        const can = !state.over && state.turn === myRole && !me.f;
        const rate = me.s ? 2 : 1;
        
        document.getElementById('val-call').innerText = state.base * rate;
        document.getElementById('val-raise').innerText = state.base * 2 * rate;
        document.getElementById('val-comp').innerText = state.base * 2 * rate;

        document.getElementById('btn-fold').disabled = !can;
        document.getElementById('btn-look').disabled = !can || me.s;
        document.getElementById('btn-call').disabled = !can || me.c < state.base * rate;
        document.getElementById('btn-raise').disabled = !can || me.c < state.base * 2 * rate;
        document.getElementById('btn-comp').disabled = !can || me.c < state.base * 2 * rate;

        // é‡å¼€æŒ‰é’®
        const rBtn = document.getElementById('btn-restart');
        if(state.over && state.winner !== 'broken') {
            rBtn.style.display = 'block';
            rBtn.innerText = me.r ? "ç­‰å¾…å¯¹æ–¹..." : "å‡†å¤‡ä¸‹ä¸€å±€";
            rBtn.style.background = me.r ? "#95a5a6" : "#f1c40f";
        } else {
            rBtn.style.display = 'none';
        }
    }

    function drawCards(id, cards, show) {
        const el = document.getElementById(id); el.innerHTML = '';
        cards.forEach(c => {
            const d = document.createElement('div');
            if(show) { d.className = `card ${['â™¥','â™¦'].includes(c.s)?'red':''}`; d.innerHTML = `${c.s}<br>${c.r}`; }
            else { d.className = 'card back'; }
            el.appendChild(d);
        });
    }

    function copyId() { document.getElementById('my-id').select(); document.execCommand('copy'); toast("å·²å¤åˆ¶"); }

    // --- ç®—æ³• ---
    function score(h) {
        let v = h.map(c=>c.v).sort((a,b)=>b-a);
        let s = h.map(c=>c.s);
        let fl = s[0]==s[1] && s[1]==s[2];
        let st = (v[0]-v[1]==1&&v[1]-v[2]==1) || (v[0]==14&&v[1]==3&&v[2]==2);
        if(v[0]==14&&v[1]==3&&v[2]==2 && st) v=[3,2,1];
        if(v[0]==v[2]) return [6,v[0]]; if(fl&&st) return [5,v[0]]; if(fl) return [4,...v];
        if(st) return [3,v[0]]; if(v[0]==v[1]) return [2,v[0],v[2]]; if(v[1]==v[2]) return [2,v[1],v[0]];
        return [1,...v];
    }
    function cmp(a,b) { for(let i=0;i<a.length;i++) { if(a[i]>b[i]) return 1; if(a[i]<b[i]) return -1; } return 0; }
</script>
</body>
</html>
