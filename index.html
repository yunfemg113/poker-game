<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‚¸é‡‘èŠ± Pro (æ­£å¼ç‰ˆ)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- æ²‰æµ¸å¼æ¸¸æˆæ ·å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #1b262c; color: #ecf0f1; text-align: center; margin: 0; padding: 0; user-select: none; -webkit-touch-callout: none; overflow: hidden; height: 100vh; width: 100vw; }
        .container { max-width: 600px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; position: relative; }
        
        /* å¤§å… */
        #lobby { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #2c3e50; z-index: 200; }
        h1 { color:#f1c40f; font-size: 40px; margin: 0 0 10px 0; text-shadow: 2px 2px 0 #000; letter-spacing: 2px; }
        .input-group { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; width: 80%; display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(5px); }
        input { padding: 15px; border-radius: 8px; border: none; text-align: center; font-size: 18px; outline: none; background: #ecf0f1; color: #2c3e50; font-weight: bold; width: 100%; box-sizing: border-box; }
        .btn-main { background: #2980b9; color: white; padding: 15px 0; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; width: 100%; box-shadow: 0 4px 0 #154360; }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: #27ae60; box-shadow: 0 4px 0 #145a32; }
        
        /* æ¸¸æˆæ¡Œ */
        #game-area { display: none; background: radial-gradient(circle, #27ae60 0%, #145a32 100%); flex: 1; position: relative; flex-direction: column; }
        
        /* é¡¶éƒ¨åº•æ± ä¿¡æ¯ */
        .pot-display { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.5); padding: 10px 40px; border-radius: 40px; border: 2px solid #f1c40f; text-align: center; z-index: 5; }
        .pot-num { color: #f1c40f; font-size: 36px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        /* æ¶ˆæ¯æç¤º */
        .msg-tip { position: absolute; top: 48%; width: 100%; text-align: center; color: white; text-shadow: 0 1px 2px black; font-size: 14px; font-weight: bold; pointer-events: none; z-index: 10; }

        /* ç©å®¶åŒºåŸŸ */
        .player-zone { position: absolute; width: 100%; height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .opponent { top: 10px; }
        .me { bottom: 90px; }

        /* çŠ¶æ€æ¡ */
        .status-bar { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; display: flex; gap: 10px; align-items: center; border: 1px solid rgba(255,255,255,0.2); margin-bottom: 8px; }
        .chips-icon { color: #f1c40f; }

        /* æ‰‘å…‹ç‰Œ */
        .cards-row { display: flex; justify-content: center; gap: 5px; }
        .card { width: 56px; height: 84px; background: white; border-radius: 6px; color: black; font-weight: bold; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); border: 1px solid #bdc3c7; position: relative; transition: transform 0.3s; }
        .card.red { color: #c0392b; }
        .card.back { background: #34495e; border: 2px solid #fff; background-image: repeating-linear-gradient(45deg, #34495e 0, #34495e 5px, #2c3e50 5px, #2c3e50 10px); color: transparent; }
        
        /* åº•éƒ¨æ“ä½œæ  */
        #action-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background: rgba(0,0,0,0.9); display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .btn-act { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 13px; font-weight: bold; position: relative; box-shadow: 0 4px 0 rgba(0,0,0,0.5); cursor: pointer; transition: 0.1s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn-act:active { transform: translateY(4px); box-shadow: none; }
        .btn-act:disabled { filter: grayscale(1); opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* é¢œè‰²å®šä¹‰ */
        .c-fold { background: #c0392b; }
        .c-look { background: #2980b9; }
        .c-call { background: #27ae60; }
        .c-raise { background: #e67e22; }
        .c-comp { background: #8e44ad; }
        
        .cost-badge { background: #f1c40f; color: black; font-size: 10px; padding: 1px 6px; border-radius: 4px; margin-top: 2px; }

        /* æç¤ºæ¡† */
        #toast { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 8px; z-index: 999; display: none; border: 1px solid #f1c40f; }
        
        /* å‡†å¤‡ä¸‹ä¸€å±€æŒ‰é’® */
        #btn-restart { position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%); padding: 15px 40px; background: #f1c40f; color: #000; font-weight: bold; border: none; border-radius: 50px; font-size: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 150; display: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="toast">æç¤ºä¿¡æ¯</div>

<div class="container">
    <div id="lobby">
        <h1>â™ ï¸ ç‚¸é‡‘èŠ± Pro</h1>
        <p style="color:#bdc3c7; margin-bottom: 20px; font-size: 12px;">å››çº¿è·¯æé€Ÿç¨³å®šç‰ˆ</p>
        
        <div class="input-group" id="group-start">
            <button class="btn-main" onclick="initHost()">æˆ‘æ˜¯æˆ¿ä¸» (å»ºæˆ¿)</button>
            <div style="text-align:center; color:rgba(255,255,255,0.3); font-size:12px;">â€” æˆ– â€”</div>
            <input type="text" id="dest-id" placeholder="ç²˜è´´æˆ¿ä¸» ID">
            <button class="btn-main btn-green" onclick="initGuest()">åŠ å…¥æˆ¿é—´</button>
        </div>

        <div class="input-group" id="group-host" style="display:none;">
            <p style="color:#fff; margin:0;">æˆ¿é—´å·²åˆ›å»ºï¼Œè¯·å¤åˆ¶ ID å‘ç»™å¥½å‹:</p>
            <input type="text" id="my-id" readonly onclick="copyId()" style="font-family: monospace; letter-spacing: 1px; background:#fff;">
            <p id="host-status" style="color: #f1c40f; font-size:14px;">â³ ç­‰å¾…è¿æ¥...</p>
            <button class="btn-main" onclick="location.reload()" style="background:#7f8c8d; padding: 10px;">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="game-area">
        <div class="pot-display">
            <div style="font-size:10px; color:rgba(255,255,255,0.7)">åº•æ± </div>
            <div class="pot-num" id="pot">0</div>
            <div style="font-size:10px; color:#f1c40f">åº•æ³¨: <span id="base">10</span></div>
        </div>
        
        <div class="msg-tip" id="msg">åˆå§‹åŒ–ä¸­...</div>

        <div class="player-zone opponent">
            <div class="status-bar">
                <span id="opp-status">ç­‰å¾…ä¸­</span>
                <span class="chips-icon">ğŸ’°</span> <span id="opp-chips">1000</span>
            </div>
            <div class="cards-row" id="opp-cards">
                <div class="card back"></div><div class="card back"></div><div class="card back"></div>
            </div>
        </div>

        <button id="btn-restart" onclick="sendAction('ready')">å‡†å¤‡ä¸‹ä¸€å±€</button>

        <div class="player-zone me">
            <div class="cards-row" id="my-cards">
                <div class="card back"></div><div class="card back"></div><div class="card back"></div>
            </div>
            <div class="status-bar" style="margin-top:10px;">
                <span id="my-status" style="color:#f1c40f">å‡†å¤‡</span>
                <span class="chips-icon">ğŸ’°</span> <span id="my-chips">1000</span>
            </div>
        </div>

        <div id="action-bar">
            <button class="btn-act c-fold" id="btn-fold" onclick="sendAction('fold')">å¼ƒç‰Œ</button>
            <button class="btn-act c-look" id="btn-look" onclick="sendAction('look')">çœ‹ç‰Œ</button>
            <button class="btn-act c-call" id="btn-call" onclick="sendAction('call')">è·Ÿæ³¨<span class="cost-badge" id="val-call">10</span></button>
            <button class="btn-act c-raise" id="btn-raise" onclick="sendAction('raise')">åŠ æ³¨<span class="cost-badge" id="val-raise">20</span></button>
            <button class="btn-act c-comp" id="btn-comp" onclick="sendAction('comp')">æ¯”ç‰Œ<span class="cost-badge" id="val-comp">40</span></button>
        </div>
    </div>
</div>

<script>
    // --- æœ€ç»ˆç‰ˆé…ç½®ï¼šé›†æˆå¤šçº¿è·¯ STUN ---
    const PEER_CONFIG = {
        config: {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun.mit.edu:8001' },
                { urls: 'stun:stun.qq.com:3478' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        },
        debug: 1
    };

    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
    const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    const VALS = {'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
    
    let peer, conn, isHost = false, myRole = 'guest';
    let state = {
        pot: 0, base: 10, turn: '', over: true, winner: null,
        p: { host: {c:1000, h:[], s:false, f:false, r:false}, guest: {c:1000, h:[], s:false, f:false, r:false} }
    };

    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }

    // --- ç½‘ç»œ ---
    function initHost() {
        isHost = true; myRole = 'host';
        document.getElementById('group-start').style.display = 'none';
        document.getElementById('group-host').style.display = 'flex';
        peer = new Peer(null, PEER_CONFIG);
        peer.on('open', id => document.getElementById('my-id').value = id);
        peer.on('connection', c => { if(conn){c.close();return;} conn=c; bindConn(); });
        peer.on('error', e => toast("ç½‘ç»œé”™è¯¯: "+e.type));
    }

    function initGuest() {
        isHost = false; myRole = 'guest';
        const dest = document.getElementById('dest-id').value.trim();
        if(!dest) return toast("è¯·è¾“å…¥æˆ¿ä¸» ID");
        toast("æ­£åœ¨è¿æ¥...");
        peer = new Peer(null, PEER_CONFIG);
        peer.on('open', () => { conn = peer.connect(dest, {reliable:true}); bindConn(); });
        peer.on('error', e => toast("è¿æ¥å¤±è´¥: "+e.type));
    }

    function bindConn() {
        conn.on('open', () => {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-area').style.display = 'flex';
            if(isHost) resetGame(); else conn.send({t:'HELLO'});
        });
        conn.on('data', d => {
            if(d.t==='STATE') { state=d.pl; render(); }
            if(d.t==='HELLO' && isHost) sync();
            if(d.t==='ACT' && isHost) handleAct('guest', d.act);
        });
        conn.on('close', () => { alert("è¿æ¥æ–­å¼€"); location.reload(); });
    }
    function sync() { if(isHost&&conn) conn.send({t:'STATE', pl:state}); render(); }

    // --- é€»è¾‘ ---
    function resetGame() {
        if(!isHost) return;
        let deck = []; SUITS.forEach(s=>RANKS.forEach(r=>deck.push({s,r,v:VALS[r]})));
        deck.sort(()=>Math.random()-0.5);
        if(state.p.host.c<10 || state.p.guest.c<10) { state.over=true; state.winner='broken'; sync(); return; }
        state.pot=0; state.base=10; state.over=false; state.winner=null;
        state.turn=Math.random()>0.5?'host':'guest';
        ['host','guest'].forEach(r=>{
            state.p[r].h=[deck.pop(),deck.pop(),deck.pop()];
            state.p[r].s=false; state.p[r].f=false; state.p[r].r=false;
            state.p[r].c-=10; state.pot+=10;
        });
        sync();
    }

    function handleAct(role, act) {
        if(!isHost) return;
        const p=state.p[role], opp=state.p[role==='host'?'guest':'host'];
        if(act==='ready') {
            p.r=true;
            if(state.p.host.r && state.p.guest.r) resetGame(); else sync();
            return;
        }
        if(state.over || state.turn!==role) return;
        let cost=0;
        switch(act) {
            case 'look': p.s=true; break;
            case 'fold': p.f=true; endGame(role==='host'?'guest':'host'); return;
            case 'call': 
                cost=state.base*(p.s?2:1);
                if(p.c>=cost){ p.c-=cost; state.pot+=cost; state.turn=role==='host'?'guest':'host'; } break;
            case 'raise':
                state.base=Math.min(state.base*2, 200); cost=state.base*(p.s?2:1);
                if(p.c>=cost){ p.c-=cost; state.pot+=cost; state.turn=role==='host'?'guest':'host'; } else state.base/=2; break;
            case 'comp':
                cost=state.base*(p.s?2:1)*2;
                if(p.c>=cost){
                    p.c-=cost; state.pot+=cost;
                    endGame(cmp(score(p.h), score(opp.h))>0?role:(role==='host'?'guest':'host')); return;
                } break;
        }
        sync();
    }
    function endGame(w) { state.over=true; state.winner=w; if(w!=='broken') state.p[w].c+=state.pot; state.p.host.s=true; state.p.guest.s=true; sync(); }

    function sendAction(a) { if(isHost) handleAct('host',a); else conn.send({t:'ACT', act:a}); }

    // --- æ¸²æŸ“ ---
    function render() {
        const me=state.p[myRole], opp=state.p[myRole==='host'?'guest':'host'];
        document.getElementById('pot').innerText=state.pot;
        document.getElementById('base').innerText=state.base;
        document.getElementById('my-chips').innerText=me.c;
        document.getElementById('opp-chips').innerText=opp.c;

        if(state.winner==='broken') document.getElementById('msg').innerText="æœ‰äººç ´äº§äº†ï¼Œåˆ·æ–°é‡æ¥";
        else if(state.over) document.getElementById('msg').innerText=state.winner===myRole?"ğŸ‰ ä½ èµ¢äº†!":"ğŸ˜­ ä½ è¾“äº†";
        else document.getElementById('msg').innerText=state.turn===myRole?"ğŸ‘‰ è½®åˆ°ä½ äº†":"â³ å¯¹æ–¹æ€è€ƒä¸­...";

        document.getElementById('my-status').innerText=me.f?"å·²å¼ƒ":me.s?"å·²çœ‹":"é—·ç‰Œ";
        document.getElementById('opp-status').innerText=opp.f?"å·²å¼ƒ":opp.s?"å·²çœ‹":"é—·ç‰Œ";

        drawCards('my-cards', me.h, me.s||state.over);
        drawCards('opp-cards', opp.h, state.over);

        const can=!state.over && state.turn===myRole && !me.f;
        const r=me.s?2:1;
        document.getElementById('val-call').innerText=state.base*r;
        document.getElementById('val-raise').innerText=state.base*2*r;
        document.getElementById('val-comp').innerText=state.base*2*r;

        document.getElementById('btn-fold').disabled=!can;
        document.getElementById('btn-look').disabled=!can||me.s;
        document.getElementById('btn-call').disabled=!can||me.c<state.base*r;
        document.getElementById('btn-raise').disabled=!can||me.c<state.base*2*r;
        document.getElementById('btn-comp').disabled=!can||me.c<state.base*2*r;

        const rb=document.getElementById('btn-restart');
        if(state.over && state.winner!=='broken') {
            rb.style.display='block'; rb.innerText=me.r?"ç­‰å¾…å¯¹æ–¹...":"å‡†å¤‡ä¸‹ä¸€å±€";
            rb.style.background=me.r?"#7f8c8d":"#f1c40f";
        } else rb.style.display='none';
    }

    function drawCards(id, cs, s) {
        const el=document.getElementById(id); el.innerHTML='';
        cs.forEach(c=>{
            const d=document.createElement('div');
            d.className=s?`card ${['â™¥','â™¦'].includes(c.s)?'red':''}`:'card back';
            if(s) d.innerHTML=`${c.s}<br>${c.r}`;
            el.appendChild(d);
        });
    }
    function copyId() { document.getElementById('my-id').select(); document.execCommand('copy'); toast("å·²å¤åˆ¶"); }

    function score(h) {
        let v=h.map(c=>c.v).sort((a,b)=>b-a), s=h.map(c=>c.s);
        let fl=s[0]==s[1]&&s[1]==s[2], st=(v[0]-v[1]==1&&v[1]-v[2]==1)||(v[0]==14&&v[1]==3&&v[2]==2);
        if(v[0]==14&&v[1]==3&&v[2]==2 && st) v=[3,2,1];
        if(v[0]==v[2]) return [6,v[0]]; if(fl&&st) return [5,v[0]]; if(fl) return [4,...v];
        if(st) return [3,v[0]]; if(v[0]==v[1]) return [2,v[0],v[2]]; if(v[1]==v[2]) return [2,v[1],v[0]];
        return [1,...v];
    }
    function cmp(a,b) { for(let i=0;i<a.length;i++){if(a[i]>b[i])return 1;if(a[i]<b[i])return -1;} return 0; }
</script>
</body>
</html>
