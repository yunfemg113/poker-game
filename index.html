<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‚¸é‡‘èŠ± (ç½‘ç»œè¯Šæ–­ç‰ˆ)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        /* è¯Šæ–­æ§åˆ¶å° */
        #debug-console { 
            background: #000; color: #0f0; font-family: monospace; 
            font-size: 12px; text-align: left; padding: 10px; 
            height: 120px; overflow-y: scroll; border: 1px solid #444;
            margin-bottom: 20px; border-radius: 5px;
        }

        /* ç•Œé¢å…ƒç´  */
        input { padding: 10px; width: 70%; margin: 10px 0; border-radius: 5px; border: none; }
        button { padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; margin: 5px; }
        .btn-host { background: #3498db; color: white; }
        .btn-join { background: #2ecc71; color: white; }
        
        /* æ¸¸æˆæ¡Œï¼ˆç®€åŒ–æ˜¾ç¤ºï¼Œé‡ç‚¹åœ¨è¿æ¥ï¼‰ */
        #game-area { display: none; background: #27ae60; padding: 20px; border-radius: 10px; height: 400px; position: relative; }
        .card-zone { margin: 20px 0; border: 2px dashed rgba(255,255,255,0.3); padding: 10px; min-height: 100px; }
        
        /* çŠ¶æ€ç¯ */
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #555; margin-right: 5px; }
        .status-ok { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-err { background: #e74c3c; box-shadow: 0 0 5px #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <h3>ğŸ› ï¸ ç½‘ç»œè¯Šæ–­ç‰ˆ v3.0</h3>
    
    <div id="debug-console">ç³»ç»Ÿåˆå§‹åŒ–...<br>æ£€æŸ¥ WebRTC æ”¯æŒ... OK<br></div>

    <div id="lobby">
        <div style="border: 1px solid #444; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p>æˆ¿ä¸»æ“ä½œåŒº</p>
            <button class="btn-host" onclick="initHost()">åˆ›å»ºæˆ¿é—´</button>
            <br>
            <input type="text" id="my-id" readonly placeholder="ç‚¹å‡»åˆ›å»ºç”ŸæˆID" onclick="this.select(); document.execCommand('copy'); log('å·²å¤åˆ¶ID')">
        </div>

        <div style="border: 1px solid #444; padding: 15px; border-radius: 8px;">
            <p>åŠ å…¥è€…æ“ä½œåŒº</p>
            <input type="text" id="dest-id" placeholder="ç²˜è´´æˆ¿ä¸»ID">
            <br>
            <button class="btn-join" onclick="initGuest()">å°è¯•è¿æ¥</button>
        </div>
    </div>

    <div id="game-area">
        <h2 style="margin:0">è¿æ¥æˆåŠŸ! âœ…</h2>
        <p>å¦‚æœä½ çœ‹åˆ°è¿™ä¸ªç”»é¢ï¼Œè¯´æ˜ç½‘ç»œå·²æ‰“é€šã€‚</p>
        <div class="card-zone">
            <p>å¯¹æ‰‹çŠ¶æ€</p>
            <div id="opp-status">ç­‰å¾…æ•°æ®...</div>
        </div>
        <div class="card-zone">
            <p>æˆ‘çš„çŠ¶æ€</p>
            <div id="my-status">åœ¨çº¿</div>
        </div>
        <button onclick="sendPing()">å‘é€æµ‹è¯•ä¿¡å·</button>
    </div>
</div>

<script>
    // --- 1. æ—¥å¿—ç³»ç»Ÿ ---
    function log(msg, type='info') {
        const console = document.getElementById('debug-console');
        const color = type === 'err' ? '#ff4444' : (type === 'good' ? '#00ff00' : '#ccc');
        const time = new Date().toTimeString().split(' ')[0];
        console.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
        console.scrollTop = console.scrollHeight;
    }

    // --- 2. å¤šçº¿è·¯é…ç½® (ä¿®å¤ä»£ç æ ¸å¿ƒ) ---
    const PEER_CONFIG = {
        config: {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },        // è°·æ­Œ (å…¨çƒé€šç”¨)
                { urls: 'stun:stun.mit.edu:8001' },              // éº»çœç†å·¥ (å¤‡ç”¨)
                { urls: 'stun:stun.qq.com:3478' },               // è…¾è®¯ (å›½å†…ä¼˜åŒ–)
                { urls: 'stun:global.stun.twilio.com:3478' }     // Twilio (å•†ä¸šçº§ç¨³å®š)
            ]
        },
        debug: 2
    };

    let peer = null;
    let conn = null;

    // --- 3. æµè§ˆå™¨å…¼å®¹æ£€æŸ¥ ---
    if (!window.RTCPeerConnection) {
        log("âŒ è‡´å‘½é”™è¯¯: ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ WebRTC (æ— æ³•è”æœº)", "err");
        alert("è¯·ä½¿ç”¨ Chrome, Edge æˆ– Safari æµè§ˆå™¨ï¼");
    }

    // --- æˆ¿ä¸»é€»è¾‘ ---
    function initHost() {
        if(peer) peer.destroy();
        log("æ­£åœ¨è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨ (å¤šçº¿è·¯)...");
        
        peer = new Peer(null, PEER_CONFIG);

        peer.on('open', id => {
            document.getElementById('my-id').value = id;
            log(`âœ… IDç”ŸæˆæˆåŠŸ!`, "good");
            log(`ID: ${id}`);
            log("è¯·å¤åˆ¶IDå‘ç»™æœ‹å‹ï¼Œå¹¶ç­‰å¾…è¿æ¥...");
        });

        peer.on('connection', c => {
            log(`æ”¶åˆ°æ¥è‡ª ${c.peer} çš„è¿æ¥è¯·æ±‚...`);
            conn = c;
            setupConn();
        });

        peer.on('error', err => handleError(err));
        peer.on('disconnected', () => log("ä¸æœåŠ¡å™¨æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...", "err"));
    }

    // --- åŠ å…¥è€…é€»è¾‘ ---
    function initGuest() {
        const destId = document.getElementById('dest-id').value.trim();
        if(!destId) return log("âŒ è¯·å…ˆè¾“å…¥æˆ¿ä¸» ID", "err");
        
        if(peer) peer.destroy();
        log("æ­£åœ¨åˆå§‹åŒ– Peer...", "info");

        peer = new Peer(null, PEER_CONFIG);

        peer.on('open', myId => {
            log("æˆ‘æ–¹ç½‘ç»œå°±ç»ªï¼Œå¼€å§‹ç©¿é€é˜²ç«å¢™...", "info");
            log(`ç›®æ ‡ID: ${destId}`);
            
            // å…³é”®ï¼šå¼ºåˆ¶å¯é æ€§æ¨¡å¼
            conn = peer.connect(destId, { reliable: true });
            
            // è®¾ç½®è¿æ¥è¶…æ—¶æ£€æµ‹
            setTimeout(() => {
                if(!conn.open) log("âš ï¸ è¿æ¥è€—æ—¶è¿‡é•¿ï¼Œå»ºè®®åˆ·æ–°é‡è¯•æˆ–åˆ‡æ¢4G", "err");
            }, 8000);

            setupConn();
        });

        peer.on('error', err => handleError(err));
    }

    // --- é€šç”¨è¿æ¥å¤„ç† ---
    function setupConn() {
        conn.on('open', () => {
            log("âœ…âœ… P2P é€šé“æ‰“é€šäº†ï¼", "good");
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            
            // ç«‹å³å‘é€æ¡æ‰‹
            conn.send('HELLO');
        });

        conn.on('data', data => {
            log(`æ”¶åˆ°æ•°æ®: ${data}`, "good");
            document.getElementById('opp-status').innerText = "å¯¹æ–¹åœ¨çº¿ - " + new Date().toTimeString();
        });

        conn.on('close', () => {
            log("âŒ è¿æ¥å·²æ–­å¼€", "err");
            alert("è¿æ¥æ–­å¼€");
            location.reload();
        });
        
        conn.on('error', (err) => {
            log("è¿æ¥å±‚é”™è¯¯: " + err, "err");
        });
    }

    function sendPing() {
        if(conn && conn.open) {
            conn.send('PING - ä¿¡å·æµ‹è¯•');
            log("å·²å‘é€æµ‹è¯•ä¿¡å·");
        } else {
            log("âŒ å‘é€å¤±è´¥ï¼Œè¿æ¥æœªå»ºç«‹", "err");
        }
    }

    // --- é”™è¯¯ä»£ç ç¿»è¯‘ ---
    function handleError(err) {
        let msg = err.type;
        if(err.type === 'peer-unavailable') msg = "âŒ æ‰¾ä¸åˆ°è¯¥ID (å¯èƒ½è¾“é”™æˆ–æˆ¿ä¸»å·²æ‰çº¿)";
        if(err.type === 'network') msg = "âŒ ç½‘ç»œè¿æ¥ä¸¢å¤±";
        if(err.type === 'browser-incompatible') msg = "âŒ æµè§ˆå™¨ä¸å…¼å®¹";
        
        log(msg, "err");
        console.error(err);
    }
</script>
</body>
</html>
